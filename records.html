<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CarbonWise | My Records</title>
  <style>
    :root {
      --ink: #0f172a;
      --muted: #4b5563;
      --line: #e5e7eb;
      --card: #ffffff;
      --accent: #0f766e;
      --accent-soft: #e0f2f1;
      --bg: #f7f8fb;
      font-family: "SF Pro Display", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--ink);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--bg);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
    }
    .shell {
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 20px 80px;
    }
    header {
      padding: 70px 20px 40px;
      background: radial-gradient(circle at 20% 25%, rgba(224, 242, 241, 0.35), transparent 28%), #0f172a;
      color: #f8fafc;
      text-align: left;
    }
    header .shell { padding-bottom: 30px; }
    h1 {
      margin: 0 0 14px;
      font-size: clamp(34px, 4vw, 46px);
      letter-spacing: -0.015em;
      line-height: 1.2;
    }
    .subhead {
      font-size: 1.15rem;
      color: #dbeafe;
      max-width: 680px;
      margin: 0 0 18px;
    }
    .top-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }
    .tag {
      display: inline-block;
      padding: 6px 10px;
      background: #e0f2f1;
      color: #0f766e;
      border-radius: 999px;
      font-weight: 600;
      font-size: 0.9rem;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 14px 18px;
      border-radius: 12px;
      border: 1px solid transparent;
      font-weight: 700;
      text-decoration: none;
      cursor: pointer;
      color: inherit;
    }
    .btn.primary { background: #22c55e; color: #0f172a; }
    .btn.secondary { background: #f8fafc; border-color: #cbd5e1; color: #0f172a; }
    .btn.active {
      background: #d1fae5;
      border-color: #16a34a;
      color: #0f172a;
      pointer-events: none;
    }
    section {
      margin-top: 26px;
      padding: 22px 20px;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 16px;
      box-shadow: 0 16px 44px rgba(15, 23, 42, 0.08);
    }
    h2 { margin: 0 0 10px; font-size: 1.6rem; letter-spacing: -0.01em; }
    .muted { color: var(--muted); }
    .table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    .table th, .table td { padding: 10px; border-bottom: 1px solid #e5e7eb; text-align: left; }
    .table th { font-weight: 700; font-size: 0.95rem; color: var(--muted); }
    .table td { font-size: 0.95rem; }
    .carbon-summary {
      margin-top: 20px;
      padding: 18px 16px;
      background: #f8fafc;
      border: 1px solid #e5e7eb;
      border-radius: 14px;
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.06);
    }
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-top: 10px;
    }
    .summary-card {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 12px;
    }
    .summary-card .label { color: var(--muted); font-size: 0.95rem; }
    .summary-card .value { font-weight: 800; font-size: 1.3rem; margin-top: 6px; }
    .summary-card .unit { color: var(--muted); font-size: 0.9rem; }
    .carbon-reminders {
      margin-top: 18px;
      padding: 16px;
      background: #f8fafc;
      border: 1px solid #e5e7eb;
      border-radius: 14px;
    }
    .reminder-list {
      margin: 10px 0 0;
      padding-left: 18px;
      color: var(--muted);
    }
    .reminder-list li { margin-bottom: 6px; }
    .reminder-list .placeholder { list-style: none; padding-left: 0; }
    .records-filters {
      position: sticky;
      top: 0;
      z-index: 10;
      display: flex;
      gap: 12px;
      align-items: center;
      padding: 12px 0;
      background: var(--bg);
      flex-wrap: wrap;
    }
    .records-filters label {
      font-weight: 600;
      color: var(--muted);
      font-size: 0.95rem;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .records-filters select {
      padding: 8px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      min-width: 140px;
    }
    .slide-panel {
      position: fixed;
      top: 0;
      right: 0;
      width: min(420px, 100%);
      height: 100%;
      background: #fff;
      box-shadow: -8px 0 24px rgba(15, 23, 42, 0.1);
      border-left: 1px solid #e5e7eb;
      padding: 16px;
      overflow-y: auto;
      transform: translateX(100%);
      transition: transform 0.25s ease;
      z-index: 1000;
    }
    .slide-panel.active { transform: translateX(0); }
    .hidden { display: none; }
  </style>
</head>
<body>
  <header>
    <div class="shell">
      <div class="top-row">
        <div class="tag">CarbonWise</div>
        <div style="display:flex;gap:10px;align-items:center;">
          <a class="btn secondary" href="index.html#calculator">Calculator</a>
          <a class="btn primary active" href="records.html" aria-current="page">My Records</a>
          <button class="btn secondary" id="records-signout">Sign out</button>
        </div>
      </div>
      <h1>My Records</h1>
      <p class="subhead">Your saved Scope 2 electricity emissions.</p>
    </div>
  </header>

  <div class="shell">
    <section class="carbon-summary">
      <h2 style="margin:0;">Carbon Snapshot (YTD)</h2>
      <div class="summary-grid">
        <div class="summary-card">
          <div class="label">Total Scope 2</div>
          <div class="value" id="totalEmissions">—</div>
          <div class="unit">tCO₂e</div>
        </div>
        <div class="summary-card">
          <div class="label">Avg / Month</div>
          <div class="value" id="avgEmissions">—</div>
          <div class="unit">tCO₂e</div>
        </div>
        <div class="summary-card">
          <div class="label">Highest Region</div>
          <div class="value" id="topRegion">—</div>
        </div>
        <div class="summary-card">
          <div class="label">Coverage</div>
          <div class="value" id="recordCount">—</div>
          <div class="unit">months</div>
        </div>
      </div>
    </section>
    <section class="carbon-reminders">
      <h3>Insights & Reminders</h3>

      <ul id="reminderList" class="reminder-list">
        <li class="placeholder">Loading insights…</li>
      </ul>
    </section>
    <section>
      <h2 style="margin:0;">Saved records</h2>
      <section class="records-filters">
        <label>
          Year
          <select id="filterYear">
            <option value="">All</option>
          </select>
        </label>

        <label>
          Region
          <select id="filterRegion">
            <option value="">All</option>
          </select>
        </label>

        <label>
          Method
          <select id="filterMethod">
            <option value="">All</option>
            <option value="location">Location-based</option>
            <option value="market">Market-based</option>
          </select>
        </label>
      </section>
      <table class="table" aria-label="Saved records">
        <thead>
          <tr>
            <th>Emissions</th>
            <th>Method</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="recordsTable"></tbody>
      </table>
    </section>
  </div>

  <div id="recordPanel" class="slide-panel hidden" aria-live="polite"></div>

  <script type="module" src="./js/records.js"></script>
  <script type="module">
    const recordsTable = document.getElementById('recordsTable');
    const recordPanel = document.getElementById('recordPanel');
    const signoutBtn = document.getElementById('records-signout');
    const SUPABASE_URL = window.SUPABASE_URL || 'https://yyzyyjxmoggrmqsgrlxc.supabase.co';
    const SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl5enl5anhtb2dncm1xc2dybHhjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxMTQ4MzMsImV4cCI6MjA4MTY5MDgzM30.BhnHmz9ADB52B_VcMdzvdyFiPvZFj_Q-jfjRqeAoQM4';

    const showMessage = (msg) => {
      if (!recordsTable) return;
      recordsTable.innerHTML = `<tr><td colspan="7" style="color:#4b5563;">${msg}</td></tr>`;
    };

    // Initial render from any cached local data
    if (window.renderRecords) window.renderRecords('recordsTable');
    if (window.renderCarbonSummary) window.renderCarbonSummary();
    if (window.renderCarbonReminders) window.renderCarbonReminders();

    let supabase = null;
    const initSupabase = async () => {
      try {
        const { createClient } = await import('https://esm.sh/@supabase/supabase-js@2');
        supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      } catch (err) {
        console.warn('Supabase client failed to load on records page', err);
      }
    };

    const refreshRecords = async () => {
      if (!supabase || !recordsTable) return;
      const { data: sessionData } = await supabase.auth.getSession();
      const session = sessionData?.session;
      if (!session) {
        showMessage('Sign in on the main page to view your records.');
        return;
      }
      const { data, error } = await supabase
        .from('scope2_records')
        .select('id,period_year,period_month,kwh,location_based_emissions,market_based_emissions,emission_factor_source,emission_factor_year,emission_factor_value,calc_country,calc_region,market_instrument_type,covered_kwh,companies(company_name,country,region)')
        .order('period_year', { ascending: false })
        .order('period_month', { ascending: false })
        .order('created_at', { ascending: false });
      if (error) {
        showMessage('Could not load records right now.');
        return;
      }
      if (window.saveRecords) window.saveRecords(data || []);
      if (window.renderRecords) window.renderRecords('recordsTable');
      if (window.renderCarbonSummary) window.renderCarbonSummary();
      if (window.renderCarbonReminders) window.renderCarbonReminders();
      if (!data || !data.length) {
        showMessage('No records yet. Save from the calculator page.');
      }
    };

    const deleteLocalRecord = (id) => {
      const current = window.loadRecords ? window.loadRecords() : [];
      const next = current.filter((r) => String(r.id) !== String(id));
      if (window.saveRecords) window.saveRecords(next);
    };

    // Wire slide-out Edit/Delete callbacks
    window.onRecordDelete = async (id) => {
      const confirmDelete = confirm('Delete this record?');
      if (!confirmDelete) return;
      if (supabase) {
        const { error } = await supabase.from('scope2_records').delete().eq('id', id);
        if (error) {
          alert('Delete failed. Please try again.');
          return;
        }
      }
      deleteLocalRecord(id);
      if (window.renderRecords) window.renderRecords('recordsTable');
      if (window.renderCarbonSummary) window.renderCarbonSummary();
      if (window.renderCarbonReminders) window.renderCarbonReminders();
    };

    window.onRecordEdit = async (id) => {
      const records = window.loadRecords ? window.loadRecords() : [];
      const record = records.find((r) => String(r.id) === String(id));
      if (!record) {
        alert('Record not found.');
        return;
      }
      const kwhInput = prompt('Update electricity (kWh):', record.kwh);
      if (kwhInput === null) return;
      const kwhVal = parseFloat(kwhInput);
      if (!kwhVal || kwhVal <= 0) {
        alert('Enter a valid kWh.');
        return;
      }
      const factorVal = Number(record.emission_factor_value || 0);
      const tonsLocation = kwhVal * factorVal;
      const covered = Number(record.covered_kwh || 0);
      const tonsMarket = record.market_based_emissions != null
        ? Math.max(kwhVal - covered, 0) * factorVal
        : null;

      if (supabase) {
        const { error } = await supabase.from('scope2_records').update({
          kwh: kwhVal,
          location_based_emissions: tonsLocation,
          market_based_emissions: tonsMarket,
          covered_kwh: record.covered_kwh || null
        }).eq('id', id);
        if (error) {
          alert('Save failed. Please try again.');
          return;
        }
      }
      const updated = records.map((r) => String(r.id) === String(id) ? { ...r, kwh: kwhVal, location_based_emissions: tonsLocation, market_based_emissions: tonsMarket } : r);
      if (window.saveRecords) window.saveRecords(updated);
      if (window.renderRecords) window.renderRecords('recordsTable');
      if (window.renderCarbonSummary) window.renderCarbonSummary();
      if (window.renderCarbonReminders) window.renderCarbonReminders();
    };

    const attachHandlers = () => {
      if (recordsTable) {
        recordsTable.addEventListener('click', (e) => {
          const btn = e.target.closest('button[data-action]');
          if (!btn) return;
          const id = btn.getAttribute('data-id');
          const action = btn.getAttribute('data-action');
          if (action === 'view' && window.openRecordPanel) {
            window.openRecordPanel(id, recordPanel?.id || 'recordPanel');
          }
        });
      }
      if (signoutBtn) {
        signoutBtn.addEventListener('click', async (e) => {
          e.preventDefault();
          if (supabase) {
            try { await supabase.auth.signOut(); } catch (err) { console.warn('Sign out failed', err); }
          }
          window.location.href = 'index.html';
        });
      }
    };

    (async () => {
      attachHandlers();
      document.querySelectorAll('.records-filters select').forEach((el) => {
        el.addEventListener('change', () => {
          if (window.renderRecords) window.renderRecords('recordsTable');
          if (window.renderCarbonSummary) window.renderCarbonSummary();
          if (window.renderCarbonReminders) window.renderCarbonReminders();
        });
      });
      await initSupabase();
      if (supabase) {
        await refreshRecords();
        supabase.auth.onAuthStateChange((_event) => {
          if (_event === 'SIGNED_IN' || _event === 'TOKEN_REFRESHED' || _event === 'SIGNED_OUT') {
            refreshRecords();
          }
        });
      } else {
        showMessage('History unavailable while offline.');
      }
    })();
  </script>
</body>
</html>
