<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CarbonWise | Scope 2 Records</title>
  <style>
    :root {
      --ink: #0f172a;
      --muted: #4b5563;
      --line: #e5e7eb;
      --card: #ffffff;
      --accent: #0f766e;
      --accent-soft: #e0f2f1;
      --bg: #f7f8fb;
      font-family: "SF Pro Display", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--ink);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--bg);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
    }
    .app-layout {
      display: flex;
      min-height: 100vh;
      background: var(--bg);
    }
    .side-nav {
      width: 230px;
      padding: 24px 18px;
      background: #0b1220;
      color: #e5e7eb;
      border-right: 1px solid #111827;
      position: sticky;
      top: 0;
      height: 100vh;
      box-sizing: border-box;
    }
    .nav-header {
      font-weight: 800;
      letter-spacing: -0.01em;
      margin-bottom: 16px;
    }
    .nav-items {
      display: flex;
      flex-direction: column;
      gap: 6px;
      height: 100%;
    }
    .nav-footer {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid rgba(148, 163, 184, 0.2);
    }
    .nav-item.logout {
      background: transparent;
      border: 1px solid rgba(148, 163, 184, 0.35);
      color: #e5e7eb;
      text-align: left;
      width: 100%;
    }
    .mobile-topbar {
      display: none;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: #0b1220;
      color: #e5e7eb;
      position: sticky;
      top: 0;
      z-index: 40;
    }
    .mobile-brand {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: #e5e7eb;
      text-decoration: none;
      font-weight: 700;
      letter-spacing: -0.01em;
    }
    .mobile-menu-btn {
      background: transparent;
      border: 1px solid rgba(148, 163, 184, 0.35);
      color: #e5e7eb;
      padding: 8px 12px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
    }
    .mobile-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      z-index: 35;
    }
    .nav-item {
      display: block;
      padding: 10px 12px;
      border-radius: 10px;
      color: #e5e7eb;
      text-decoration: none;
      font-weight: 600;
    }
    .nav-item:hover:not(.disabled) {
      background: rgba(255, 255, 255, 0.08);
    }
    .nav-item.active {
      background: rgba(34, 197, 94, 0.18);
      color: #ffffff;
      border: 1px solid rgba(34, 197, 94, 0.4);
    }
    .nav-item.disabled {
      opacity: 0.5;
      cursor: default;
    }
    .app-content {
      flex: 1;
      min-width: 0;
    }
    .shell {
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 20px 80px;
    }
    header { padding: 32px 20px 12px; color: var(--ink); }
    header .shell { padding-bottom: 0; }
    h1 {
      margin: 0 0 14px;
      font-size: clamp(34px, 4vw, 46px);
      letter-spacing: -0.015em;
      line-height: 1.2;
    }
    .subhead {
      font-size: 1.15rem;
      color: var(--muted);
      max-width: 680px;
      margin: 0 0 18px;
    }
    .top-row {
      display: none;
    }
    .nav-brand {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      background: #e0f2f1;
      color: #0f766e;
      border-radius: 999px;
      font-weight: 600;
      font-size: 0.9rem;
      margin-bottom: 16px;
      text-decoration: none;
    }
    .brand-name { font-weight: 700; }
    .brand-badge {
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(34, 197, 94, 0.18);
      border: 1px solid rgba(34, 197, 94, 0.4);
      color: #166534;
      font-size: 0.72rem;
      font-weight: 700;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 14px 18px;
      border-radius: 12px;
      border: 1px solid transparent;
      font-weight: 700;
      text-decoration: none;
      cursor: pointer;
      color: inherit;
    }
    .btn.primary { background: #22c55e; color: #0f172a; }
    .btn.secondary { background: #f8fafc; border-color: #cbd5e1; color: #0f172a; }
    .btn.active {
      background: #d1fae5;
      border-color: #16a34a;
      color: #0f172a;
      pointer-events: none;
    }
    section {
      margin-top: 26px;
      padding: 22px 20px;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 16px;
      box-shadow: 0 16px 44px rgba(15, 23, 42, 0.08);
    }
    h2 { margin: 0 0 10px; font-size: 1.6rem; letter-spacing: -0.01em; }
    .muted { color: var(--muted); }
    .metric-note { color: var(--muted); font-size: 0.85rem; margin-top: 4px; }
    .table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    .table th, .table td { padding: 10px; border-bottom: 1px solid #e5e7eb; text-align: left; }
    .table th { font-weight: 700; font-size: 0.95rem; color: var(--muted); }
    .table td { font-size: 0.95rem; }
    .carbon-summary {
      margin-top: 20px;
      padding: 18px 16px;
      background: #f8fafc;
      border: 1px solid #e5e7eb;
      border-radius: 14px;
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.06);
    }
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-top: 10px;
    }
    .summary-card {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 12px;
    }
    .summary-card .label { color: var(--muted); font-size: 0.95rem; }
    .summary-card .value { font-weight: 800; font-size: 1.3rem; margin-top: 6px; }
    .summary-card .unit { color: var(--muted); font-size: 0.9rem; }
    .carbon-reminders {
      margin-top: 18px;
      padding: 16px;
      background: #f8fafc;
      border: 1px solid #e5e7eb;
      border-radius: 14px;
    }
    .reminder-list {
      margin: 10px 0 0;
      padding-left: 18px;
      color: var(--muted);
    }
    .reminder-list li { margin-bottom: 6px; }
    .reminder-list .placeholder { list-style: none; padding-left: 0; }
    .records-controls {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 6px;
    }
    .records-filters {
      position: sticky;
      top: 0;
      z-index: 10;
      display: flex;
      gap: 12px;
      align-items: center;
      padding: 12px 0;
      background: var(--bg);
      flex-wrap: wrap;
    }
    .records-filters label {
      font-weight: 600;
      color: var(--muted);
      font-size: 0.95rem;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .records-filters select {
      padding: 8px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      min-width: 140px;
    }
    .records-actions { display: flex; align-items: center; gap: 8px; }
    .records-status { color: var(--muted); font-size: 0.9rem; }
    .note { color: var(--muted); font-size: 0.9rem; }
    .records-filters .records-actions { margin-left: auto; }
    .panel-form {
      display: grid;
      gap: 12px;
    }
    .panel-row {
      display: grid;
      gap: 10px;
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
    .panel-row.single {
      grid-template-columns: minmax(0, 1fr);
    }
    .panel-form label {
      font-weight: 600;
      color: var(--muted);
      font-size: 0.95rem;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .panel-form input,
    .panel-form select {
      padding: 8px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
    }
    .panel-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
    }
    .panel-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .panel-status { color: var(--muted); font-size: 0.9rem; }
    .panel-hint { color: var(--muted); font-size: 0.9rem; }
    .app-footer { text-align: center; padding: 16px 0 24px; font-size: 0.95rem; color: var(--muted); }
    .bulk-row {
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 10px;
      display: grid;
      gap: 10px;
    }
    .bulk-row-actions {
      display: flex;
      justify-content: flex-end;
    }
    .slide-panel {
      position: fixed;
      top: 0;
      right: 0;
      width: min(420px, 100%);
      height: 100%;
      background: #fff;
      box-shadow: -8px 0 24px rgba(15, 23, 42, 0.1);
      border-left: 1px solid #e5e7eb;
      padding: 16px;
      overflow-y: auto;
      transform: translateX(100%);
      transition: transform 0.25s ease;
      z-index: 1000;
    }
    .slide-panel.active { transform: translateX(0); }
    .hidden { display: none; }

    @media (max-width: 980px) {
      .app-layout { flex-direction: column; }
      .mobile-topbar { display: flex; }
      .side-nav {
        position: fixed;
        left: 0;
        top: 0;
        height: 100vh;
        width: 260px;
        transform: translateX(-100%);
        transition: transform 0.25s ease;
        z-index: 50;
      }
      .nav-open .side-nav { transform: translateX(0); }
      .nav-open .mobile-overlay { display: block; }
      .nav-open { overflow: hidden; }
      header { padding: 56px 20px 32px; }
      .top-row { flex-direction: column; align-items: flex-start; gap: 14px; }
      .top-row > div { flex-wrap: wrap; }
      .btn { padding: 12px 14px; }
    }

    @media (max-width: 680px) {
      .shell { padding: 0 16px 60px; }
      .nav-items { grid-auto-flow: row; }
      .records-controls { flex-direction: column; align-items: flex-start; }
      .records-filters { position: static; padding: 8px 0 12px; }
      .records-filters label { min-width: 140px; }
      .records-filters select { width: 100%; min-width: 0; }
      .table { display: block; overflow-x: auto; -webkit-overflow-scrolling: touch; }
    }
  </style>
</head>
<body>
  <div class="app-layout">
    <div class="mobile-topbar">
      <a class="mobile-brand" href="index.html" aria-label="Company"></a>
      <button class="mobile-menu-btn" id="mobile-nav-toggle" type="button">Menu</button>
    </div>
    <div class="mobile-overlay" id="mobile-nav-overlay"></div>
    <aside class="side-nav">
      <a class="nav-brand" href="index.html" aria-label="Company"></a>
      <nav class="nav-items">
        <a href="dashboard.html" class="nav-item" data-nav="dashboard">Dashboard</a>
        <a href="scope1.html" class="nav-item" data-nav="scope1">Scope 1 Records</a>
        <a href="records.html" class="nav-item" data-nav="records">Scope 2 Records</a>
        <a href="scope3.html" class="nav-item" data-nav="scope3">Scope 3 Records</a>
        <a href="insights.html" class="nav-item" data-nav="insights">Insights</a>
        <a href="exports.html" class="nav-item" data-nav="export">Export / Reports</a>
        <a href="settings.html" class="nav-item" data-nav="settings">Settings</a>
        <div class="nav-footer">
          <button class="nav-item logout" id="nav-signout" type="button">Log out</button>
        </div>
      </nav>
    </aside>
    <div class="app-content">
      <div class="shell">
    <p class="note" id="records-auth-note">Log in on the main page to view your records.</p>
    <section class="carbon-summary">
      <h2 style="margin:0;">Scope 2 Carbon Snapshot</h2>
      <div class="summary-grid">
        <div class="summary-card">
          <div class="label">Total Scope 2 electricity</div>
          <div class="value" id="totalEmissions">—</div>
          <div class="unit">tCO₂e</div>
        </div>
        <div class="summary-card">
          <div class="label">Average per month</div>
          <div class="value" id="avgEmissions">—</div>
          <div class="unit">tCO₂e</div>
        </div>
        <div class="summary-card">
          <div class="label">Highest region</div>
          <div class="value" id="topRegion">—</div>
        </div>
        <div class="summary-card">
          <div class="label">Coverage (months with records)</div>
          <div class="value" id="recordCount">—</div>
          <div class="unit">months</div>
        </div>
        <div class="summary-card">
          <div class="label">Real-world comparison</div>
          <div class="value" id="summaryCompare">—</div>
          <div class="unit">car miles equiv.</div>
          <!-- Clarify this comparison is not a reportable metric -->
          <div class="metric-note">For intuition only (non-reporting metric)</div>
        </div>
      </div>
      <!-- Trust note for audit clarity -->
      <p class="note">Scope 2 is purchased electricity you use from the grid. Calculated using location-based factors (tCO₂e). <a href="methodology.html">See Methodology</a>.</p>
    </section>
    <section class="carbon-reminders">
      <h3>Insights & Reminders</h3>

      <ul id="reminderList" class="reminder-list">
        <li class="placeholder">Loading insights…</li>
      </ul>
    </section>
        <section>
          <div class="records-controls">
            <h2 style="margin:0;">Saved Scope 2 records</h2>
            <div class="records-actions">
              <!-- Export respects the current filters to avoid mismatched downloads -->
              <button class="btn secondary" id="records-export-csv" type="button">Export CSV</button>
              <span class="records-status" id="records-export-status"></span>
            </div>
          </div>
          <div class="note">Calculated using location-based factors (tCO₂e); market-based uses RECs/PPAs where provided. <a href="methodology.html">See Methodology</a>.</div>
          <section class="records-filters">
            <label>
              Reporting year
          <select id="filterYear">
            <option value="">All</option>
          </select>
        </label>

        <label>
          Country
          <select id="filterCountry">
            <option value="">All</option>
          </select>
        </label>

        <label>
          Region
          <select id="filterRegion">
            <option value="">All</option>
          </select>
        </label>

        <label>
          Method
          <select id="filterMethod">
            <option value="">All</option>
            <option value="location">Location-based</option>
            <option value="market">Market-based</option>
          </select>
        </label>
        <div class="records-actions">
          <button class="btn secondary" id="records-add" type="button">Add record</button>
          <button class="btn secondary" id="records-bulk" type="button">Bulk add</button>
          <span class="records-status" id="scope2-limit-status"></span>
        </div>
      </section>
      <table class="table" aria-label="Saved records">
        <thead>
          <tr>
            <th>Emissions</th>
            <th>Method</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="recordsTable">
          <tr>
            <td colspan="3" style="color:#4b5563;">Log in on the main page to view your records.</td>
          </tr>
        </tbody>
      </table>
      <p class="note">Calculated using location-based factors (tCO₂e) for display. <a href="methodology.html">See Methodology</a>.</p>
    </section>
    <footer class="app-footer">
      <!-- Trust signals in footer: methodology, support, and factor freshness -->
      <div><a href="methodology.html">Methodology</a> • <a href="mailto:hello@esgrise.com">Contact / support</a></div>
      <div>Emission factors updated as of 2024.</div>
    </footer>
  </div>

  <div id="recordPanel" class="slide-panel hidden" aria-live="polite"></div>
  </div> <!-- end app-content -->
  </div> <!-- end app-layout -->

  <script>
    (function setActiveNav() {
      const path = window.location.pathname;
      document.querySelectorAll('.nav-item').forEach((link) => {
        const href = link.getAttribute('href');
        if (href && path.includes(href)) {
          link.classList.add('active');
        }
      });
      document.querySelectorAll('.nav-item.disabled').forEach((link) => {
        link.addEventListener('click', (e) => e.preventDefault());
      });
    })();
  </script>
  <script type="module" src="./js/records.js"></script>
  <script type="module">
    import { EMISSION_FACTORS, GLOBAL_FALLBACK } from './data/emission-factors.js';
    import { ensureCompanySites } from './js/sites.js';
    const recordsTable = document.getElementById('recordsTable');
    const recordPanel = document.getElementById('recordPanel');
    const signoutBtn = document.getElementById('nav-signout');
    const exportBtn = document.getElementById('records-export-csv');
    const exportStatus = document.getElementById('records-export-status');
    const addBtn = document.getElementById('records-add');
    const bulkBtn = document.getElementById('records-bulk');
    const limitStatus = document.getElementById('scope2-limit-status');
    let sites = [];
    let sitesLoaded = false;
    let hqSite = null;
    let entitlements = null;
    const authNote = document.getElementById('records-auth-note');
    const scope3NavLink = document.querySelector('.nav-item[data-nav="scope3"]');
    const navBrand = document.querySelector('.nav-brand');
    const mobileBrand = document.querySelector('.mobile-brand');

    const PLAN_LIMIT_MESSAGE = 'Free plan limit reached (5 records). Upgrade to add more.';
    const isPlanLimitError = (error) => {
      const message = `${error?.message || ''}`.toLowerCase();
      return message.includes('row-level security')
        || message.includes('permission denied')
        || message.includes('policy');
    };
    const SUPABASE_URL = window.SUPABASE_URL || 'https://yyzyyjxmoggrmqsgrlxc.supabase.co';
    const SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl5enl5anhtb2dncm1xc2dybHhjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxMTQ4MzMsImV4cCI6MjA4MTY5MDgzM30.BhnHmz9ADB52B_VcMdzvdyFiPvZFj_Q-jfjRqeAoQM4';

    const TODAY = new Date();
    const CURRENT_YEAR = TODAY.getFullYear();
    const CURRENT_MONTH = TODAY.getMonth() + 1;
    const MONTHS = ["January","February","March","April","May","June","July","August","September","October","November","December"];
    const COUNTRY_OPTIONS = [
      { value: 'US', label: 'United States' },
      { value: 'CA', label: 'Canada' },
      { value: 'UK', label: 'United Kingdom' },
      { value: 'AU', label: 'Australia' },
      { value: 'SG', label: 'Singapore' },
      { value: 'NZ', label: 'New Zealand' }
    ];
    const REGION_OPTIONS = {
      US: [
        "Alabama","Alaska","Arizona","Arkansas","California","Colorado","Connecticut","Delaware","District of Columbia",
        "Florida","Georgia","Hawaii","Idaho","Illinois","Indiana","Iowa","Kansas","Kentucky","Louisiana","Maine",
        "Maryland","Massachusetts","Michigan","Minnesota","Mississippi","Missouri","Montana","Nebraska","Nevada",
        "New Hampshire","New Jersey","New Mexico","New York","North Carolina","North Dakota","Ohio","Oklahoma",
        "Oregon","Pennsylvania","Rhode Island","South Carolina","South Dakota","Tennessee","Texas","Utah","Vermont",
        "Virginia","Washington","West Virginia","Wisconsin","Wyoming"
      ],
      CA: [
        "Alberta","British Columbia","Manitoba","New Brunswick","Newfoundland and Labrador","Northwest Territories",
        "Nova Scotia","Nunavut","Ontario","Prince Edward Island","Quebec","Saskatchewan","Yukon"
      ],
      UK: [
        "England","Northern Ireland","Scotland","Wales"
      ],
      AU: [
        "New South Wales","Victoria","Queensland","Western Australia","South Australia",
        "Tasmania","Australian Capital Territory","Northern Territory"
      ],
      SG: [
        "Singapore"
      ],
      NZ: [
        "Auckland","Bay of Plenty","Canterbury","Gisborne","Hawke's Bay","Manawatu-Whanganui","Marlborough",
        "Nelson","Northland","Otago","Southland","Taranaki","Tasman","Waikato","Wellington","West Coast"
      ]
    };

    const normalizeKey = (str) => (str || '').trim().toUpperCase();

    const populateYears = (el, withPlaceholder = true) => {
      el.innerHTML = withPlaceholder ? '<option value="">Select year</option>' : '';
      for (let y = CURRENT_YEAR; y >= 2024; y -= 1) {
        const opt = document.createElement('option');
        opt.value = y;
        opt.textContent = y;
        el.appendChild(opt);
      }
    };

    const populateMonths = (el) => {
      el.innerHTML = '<option value="">Select month</option>';
      MONTHS.forEach((m, idx) => {
        const opt = document.createElement('option');
        opt.value = String(idx + 1);
        opt.textContent = m;
        el.appendChild(opt);
      });
    };

    const getSiteCountries = () => {
      const unique = Array.from(new Set(sites.map((site) => site.country)));
      return unique.map((country) => {
        const label = (COUNTRY_OPTIONS.find((c) => c.value === country) || {}).label || country;
        return { value: country, label };
      });
    };

    const setDisabledOptions = (el, enabledValues) => {
      if (!el) return;
      Array.from(el.options).forEach((opt) => {
        if (!opt.value) return;
        opt.disabled = !enabledValues.has(opt.value);
      });
    };

    const selectFirstEnabled = (el) => {
      if (!el) return;
      const enabled = Array.from(el.options).find((opt) => opt.value && !opt.disabled);
      if (enabled) el.value = enabled.value;
    };

    const populateCountries = (el) => {
      if (!el) return;
      const options = COUNTRY_OPTIONS;
      el.innerHTML = '<option value="">Select country</option>';
      options.forEach((c) => {
        const opt = document.createElement('option');
        opt.value = c.value;
        opt.textContent = c.label;
        el.appendChild(opt);
      });
      if (sites.length) {
        const enabled = new Set(getSiteCountries().map((c) => c.value));
        setDisabledOptions(el, enabled);
        if (el.value && !enabled.has(el.value)) selectFirstEnabled(el);
      } else if (sitesLoaded) {
        setDisabledOptions(el, new Set());
      }
    };

    const setRegionOptions = (country, regionEl) => {
      if (!regionEl) return;
      const opts = REGION_OPTIONS[country] || [];
      regionEl.innerHTML = '<option value="">Select region</option>';
      opts.forEach((name) => {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        regionEl.appendChild(opt);
      });
      if (sites.length) {
        const enabled = new Set(
          sites.filter((site) => site.country === country).map((site) => site.region)
        );
        setDisabledOptions(regionEl, enabled);
        if (regionEl.value && !enabled.has(regionEl.value)) selectFirstEnabled(regionEl);
      } else if (sitesLoaded) {
        setDisabledOptions(regionEl, new Set());
      }
    };

    const refreshPanelSiteSelectors = () => {
      if (!recordPanel || !recordPanel.classList.contains('active')) return;
      const addCountry = recordPanel.querySelector('#add-country');
      const addRegion = recordPanel.querySelector('#add-region');
      if (addCountry && addRegion) {
        populateCountries(addCountry);
        setRegionOptions(addCountry.value, addRegion);
      }
      recordPanel.querySelectorAll('.bulk-row').forEach((row) => {
        const countryEl = row.querySelector('[data-field="country"]');
        const regionEl = row.querySelector('[data-field="region"]');
        if (countryEl && regionEl) {
          populateCountries(countryEl);
          setRegionOptions(countryEl.value, regionEl);
        }
      });
      const addForm = recordPanel.querySelector('#add-record-form');
      if (addForm) {
        const submit = addForm.querySelector('button[type="submit"]');
        if (submit) submit.disabled = !sites.length;
        const status = recordPanel.querySelector('#add-status');
        if (status && sites.length) status.textContent = '';
      }
      const bulkForm = recordPanel.querySelector('#bulk-form');
      if (bulkForm) {
        const submit = bulkForm.querySelector('button[type="submit"]');
        if (submit) submit.disabled = !sites.length;
        const status = recordPanel.querySelector('#bulk-status');
        if (status && sites.length) status.textContent = '';
      }
    };

    const selectFinalFactor = (records, billingYear) => {
      const finals = (records || []).filter((r) => r.status === 'final');
      if (!finals.length) return null;
      const exact = finals.find((r) => r.year === billingYear);
      if (exact) return exact;
      return finals.reduce((latest, rec) => {
        if (!latest) return rec;
        return rec.year > latest.year ? rec : latest;
      }, null);
    };

    const getEmissionFactor = (country, region, billingYear) => {
      const countryData = EMISSION_FACTORS[country];
      const regionKey = normalizeKey(region);
      if (countryData?.regions && countryData.regions[regionKey]) {
        const data = selectFinalFactor(countryData.regions[regionKey], billingYear);
        if (data) return data;
      }
      if (countryData?.default) {
        const data = selectFinalFactor(countryData.default, billingYear);
        if (data) return data;
      }
      return selectFinalFactor(GLOBAL_FALLBACK, billingYear) || GLOBAL_FALLBACK[0];
    };
    const showMessage = (msg) => {
      if (!recordsTable) return;
      recordsTable.innerHTML = `<tr><td colspan="3" style="color:#4b5563;">${msg}</td></tr>`;
    };

    // Initial render from any cached local data
    if (window.renderRecords) window.renderRecords('recordsTable');
    if (window.renderCarbonSummary) window.renderCarbonSummary();
    if (window.renderCarbonReminders) window.renderCarbonReminders();

    let supabase = null;
    const initSupabase = async () => {
      try {
        const { createClient } = await import('https://esm.sh/@supabase/supabase-js@2');
        supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      } catch (err) {
        console.warn('Supabase client failed to load on records page', err);
      }
    };

    const refreshRecords = async () => {
      if (!supabase || !recordsTable) return;
      const { data: sessionData } = await supabase.auth.getSession();
      const session = sessionData?.session;
      if (!session) {
        if (authNote) authNote.hidden = false;
        showMessage('Log in on the main page to view your records.');
        return;
      }
      if (authNote) authNote.hidden = true;
      const { data, error } = await supabase
        .from('scope2_records')
        .select('id,site_id,period_year,period_month,kwh,location_based_emissions,market_based_emissions,emission_factor_source,emission_factor_year,emission_factor_value,calc_country,calc_region,market_instrument_type,covered_kwh,companies(company_name,country,region)')
        .order('period_year', { ascending: false })
        .order('period_month', { ascending: false })
        .order('created_at', { ascending: false });
      if (error) {
        showMessage('Could not load records right now.');
        return;
      }
      if (window.saveRecords) window.saveRecords(data || []);
      if (window.renderRecords) window.renderRecords('recordsTable');
      if (window.renderCarbonSummary) window.renderCarbonSummary();
      if (window.renderCarbonReminders) window.renderCarbonReminders();
      applyRecordGate();
      if (!data || !data.length) {
        showMessage('No records found. Add a record to include it in calculations and exports.');
      }
    };

    const closePanel = () => {
      if (!recordPanel) return;
      recordPanel.classList.remove('active');
      recordPanel.classList.add('hidden');
      recordPanel.innerHTML = '';
    };

    const openPanel = (html) => {
      if (!recordPanel) return;
      recordPanel.innerHTML = html;
      recordPanel.classList.remove('hidden');
      recordPanel.classList.add('active');
      const closeBtn = recordPanel.querySelector('[data-close-panel]');
      if (closeBtn) {
        closeBtn.addEventListener('click', closePanel, { once: true });
      }
    };

    const getSession = async () => {
      if (!supabase) return null;
      const { data } = await supabase.auth.getSession();
      return data?.session || null;
    };

    const getCompanyId = async (session) => {
      if (!supabase || !session) return null;
      const { data, error } = await supabase
        .from('companies')
        .select('id')
        .eq('user_id', session.user.id)
        .order('created_at', { ascending: true })
        .limit(1);
      if (error) {
        console.warn('Company lookup failed', error);
        return null;
      }
      return data?.[0]?.id || null;
    };

    const loadEntitlements = async (session) => {
      const companyId = await getCompanyId(session);
      if (!companyId) return null;
      const { data, error } = await supabase
        .from('entitlements')
        .select('tier,max_scope2_records,allow_scope3')
        .eq('company_id', companyId)
        .maybeSingle();
      if (error) return null;
      return data || null;
    };

    const formatTierLabel = (tier) => {
      const normalized = (tier || '').toLowerCase();
      if (normalized === 'core') return 'Core';
      if (normalized === 'complete') return 'Complete';
      return 'Free';
    };

    const setBrandLabel = (companyName, tier) => {
      const badge = companyName ? formatTierLabel(tier) : '';
      const apply = (el) => {
        if (!el) return;
        el.textContent = '';
        if (companyName) {
          const nameEl = document.createElement('span');
          nameEl.className = 'brand-name';
          nameEl.textContent = companyName;
          el.appendChild(nameEl);
        }
        if (badge) {
          const badgeEl = document.createElement('span');
          badgeEl.className = 'brand-badge';
          badgeEl.textContent = badge;
          el.appendChild(badgeEl);
        }
      };
      apply(navBrand);
      apply(mobileBrand);
    };

    const updateNavBrand = (companyName, tier) => {
      setBrandLabel(companyName || '', tier);
    };

    const updateScope3Nav = () => {
      if (!scope3NavLink) return;
      if (entitlements?.allow_scope3) {
        scope3NavLink.classList.remove('disabled');
        scope3NavLink.removeAttribute('aria-disabled');
        scope3NavLink.title = '';
      } else {
        scope3NavLink.classList.add('disabled');
        scope3NavLink.setAttribute('aria-disabled', 'true');
        scope3NavLink.title = 'Upgrade to CarbonWise Complete to unlock Scope 3.';
      }
    };

    const applyRecordGate = () => {
      const hasSites = sites.length > 0;
      const maxRecords = entitlements?.max_scope2_records ?? null;
      const currentRecords = window.loadRecords ? window.loadRecords() : [];
      const limitReached = maxRecords !== null && currentRecords.length >= maxRecords;
      const disabled = !hasSites || limitReached;
      if (addBtn) addBtn.disabled = disabled;
      if (bulkBtn) bulkBtn.disabled = disabled;
      if (limitStatus) {
        limitStatus.textContent = limitReached
          ? 'Free plan limit reached (5 records). Upgrade to add more.'
          : '';
      }
    };

    const loadCompanyPreference = async (session) => {
      if (!supabase) return;
      const { data, error } = await supabase
        .from('companies')
        .select('company_name,reporting_year_preference')
        .order('created_at', { ascending: true })
        .limit(1);
      if (error || !data || !data.length) return;
      const company = data[0] || {};
      window.companyReportingPreference = company.reporting_year_preference || 'all';
      const siteData = await ensureCompanySites(supabase, session);
      sites = siteData.sites || [];
      sitesLoaded = true;
      hqSite = siteData.hqSite || null;
      window.companyDefaults = {
        country: hqSite?.country || '',
        region: hqSite?.region || ''
      };
      updateNavBrand(company.company_name || '', entitlements?.tier);
      applyRecordGate();
      refreshPanelSiteSelectors();
    };

    const isFuturePeriod = (year, month) => (
      year > CURRENT_YEAR || (year === CURRENT_YEAR && month > CURRENT_MONTH)
    );

    const deleteLocalRecord = (id) => {
      const current = window.loadRecords ? window.loadRecords() : [];
      const next = current.filter((r) => String(r.id) !== String(id));
      if (window.saveRecords) window.saveRecords(next);
    };

    const setExportStatus = (msg) => {
      if (exportStatus) exportStatus.textContent = msg;
    };

    const toCsv = (records, fallbackCompany = '') => {
      const disclosure = 'Location-based Scope 2 electricity calculation aligned with the GHG Protocol.';
      const headers = [
        'company_name','period','country/region','kwh','scope2_location_based_tco2e','scope2_market_based_tco2e','emission_factor_value','emission_factor_year','emission_factor_source'
      ];
      const rows = (records || []).map((r) => {
        const period = `${r.period_year || r.year}-${String(r.period_month || r.month).padStart(2, '0')}`;
        const country = `${r.calc_country || ''}${r.calc_region ? ' / ' + r.calc_region : ''}`;
        return [
          r.companies?.company_name || fallbackCompany,
          period,
          country,
          r.kwh ?? '',
          r.location_based_emissions ?? '',
          r.market_based_emissions ?? '',
          r.emission_factor_value ?? '',
          r.emission_factor_year ?? '',
          r.emission_factor_source ?? ''
        ];
      });
      rows.push(['Disclosure', disclosure]);
      return [headers, ...rows].map((row) => row.map((v) => `"${String(v ?? '').replace(/"/g, '""')}"`).join(',')).join('\r\n');
    };

    const downloadCsv = (csv, filename = 'carbonwise_scope2_filtered.csv') => {
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    };

    // Export filtered data to keep downloads aligned with on-screen filters
    const exportFiltered = async () => {
      if (exportBtn) exportBtn.disabled = true;
      setExportStatus('Preparing filtered export…');
      try {
        if (!window.getFilteredRecords) {
          setExportStatus('Filters unavailable.');
          return;
        }
        if (supabase) {
          const { data: sessionData } = await supabase.auth.getSession();
          if (!sessionData?.session) {
            window.location.href = 'index.html';
            return;
          }
        }
        const filtered = window.getFilteredRecords();
        if (!filtered.length) {
          setExportStatus('No records match these filters. Add a record to include it in calculations and exports.');
          return;
        }
        const companyName = filtered[0]?.companies?.company_name || '';
        const yearVal = document.getElementById('filterYear')?.value;
        const csv = toCsv(filtered, companyName);
        const namePart = yearVal ? `${yearVal}` : 'filtered';
        downloadCsv(csv, `carbonwise_scope2_${namePart}.csv`);
        setExportStatus('Exported with current filters.');
      } catch (err) {
        console.warn('Filtered CSV export error', err);
        setExportStatus('Could not export right now.');
      } finally {
        if (exportBtn) exportBtn.disabled = false;
      }
    };

    const buildAddPanel = () => `
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:12px;">
        <div>
          <div style="font-weight:700;font-size:1.05rem;">Add record</div>
          <div style="color:#4b5563;font-size:0.95rem;">Create a single entry without leaving this page.</div>
        </div>
        <button type="button" class="btn secondary" data-close-panel style="padding:8px 10px;">×</button>
      </div>
      <form id="add-record-form" class="panel-form">
        <div class="panel-row">
          <label>
            Country / region
            <select id="add-country" required></select>
          </label>
          <label>
            State / region
            <select id="add-region" required></select>
          </label>
        </div>
        <div class="panel-row">
          <label>
            Billing month
            <select id="add-month" required></select>
          </label>
          <label>
            Billing year
            <select id="add-year" required></select>
          </label>
        </div>
        <div class="panel-hint">Enter the month electricity was consumed, not when the bill was paid. Locations not in Settings are disabled.</div>
        <div class="panel-row single">
          <label>
            Electricity (kWh)
            <input type="number" id="add-kwh" min="1" step="any" placeholder="e.g., 1200" required />
          </label>
        </div>
        <label class="panel-toggle">
          <input type="checkbox" id="add-market-toggle" />
          Include market-based Scope 2 (using RECs where provided)
        </label>
        <div class="panel-row">
          <label>
            Instrument type (market-based Scope 2)
            <select id="add-market-type">
              <option value="">None</option>
              <option value="REC">REC</option>
              <option value="PPA">PPA</option>
              <option value="Green tariff">Green tariff</option>
            </select>
          </label>
          <label>
            Covered electricity (kWh)
            <input type="number" id="add-covered" min="0" step="any" placeholder="0" />
          </label>
        </div>
        <div class="panel-row single">
          <label>
            Reporting year (market-based Scope 2)
            <select id="add-market-year"></select>
          </label>
        </div>
        <div class="panel-actions">
          <button type="submit" class="btn primary">Save record</button>
        </div>
        <p class="panel-status" id="add-status"></p>
      </form>
    `;

    const buildEditPanel = (record) => {
      const period = `${record.period_year}-${String(record.period_month).padStart(2, '0')}`;
      const region = `${record.calc_country || '—'}${record.calc_region ? ' / ' + record.calc_region : ''}`;
      return `
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:12px;">
          <div>
            <div style="font-weight:700;font-size:1.05rem;">Edit Scope 2 record</div>
            <div style="color:#4b5563;font-size:0.95rem;">${period} • ${region}</div>
          </div>
          <button type="button" class="btn secondary" data-close-panel style="padding:8px 10px;">×</button>
        </div>
        <form id="edit-record-form" class="panel-form">
          <div class="panel-row single">
            <label>
              Electricity (kWh)
              <input type="number" id="edit-kwh" min="1" step="any" value="${record.kwh ?? ''}" required />
            </label>
          </div>
          <p class="panel-hint">Market-based details (instrument type and covered kWh) are kept as-is.</p>
          <div class="panel-actions">
            <button type="submit" class="btn primary">Save changes</button>
          </div>
          <p class="panel-status" id="edit-status"></p>
        </form>
      `;
    };

    const openAddPanel = () => {
      openPanel(buildAddPanel());
      const form = recordPanel?.querySelector('#add-record-form');
      const countryEl = recordPanel?.querySelector('#add-country');
      const regionEl = recordPanel?.querySelector('#add-region');
      const monthEl = recordPanel?.querySelector('#add-month');
      const yearEl = recordPanel?.querySelector('#add-year');
      const kwhEl = recordPanel?.querySelector('#add-kwh');
      const marketToggle = recordPanel?.querySelector('#add-market-toggle');
      const marketTypeEl = recordPanel?.querySelector('#add-market-type');
      const coveredEl = recordPanel?.querySelector('#add-covered');
      const marketYearEl = recordPanel?.querySelector('#add-market-year');
      const statusEl = recordPanel?.querySelector('#add-status');

      if (!form || !countryEl || !regionEl || !monthEl || !yearEl || !kwhEl || !marketToggle || !marketTypeEl || !coveredEl || !marketYearEl) {
        return;
      }

      if (!sitesLoaded) {
        const statusEl = recordPanel?.querySelector('#add-status');
        if (statusEl) statusEl.textContent = 'Loading site list…';
        form.querySelector('button[type="submit"]').disabled = true;
      } else if (!sites.length) {
        const statusEl = recordPanel?.querySelector('#add-status');
        if (statusEl) statusEl.textContent = 'Add at least one site in Settings before creating records.';
        form.querySelector('button[type="submit"]').disabled = true;
      }

      populateCountries(countryEl);
      populateMonths(monthEl);
      populateYears(yearEl);
      populateYears(marketYearEl);
      setRegionOptions(countryEl.value, regionEl);
      marketTypeEl.disabled = true;
      coveredEl.disabled = true;
      marketYearEl.disabled = true;

      countryEl.addEventListener('change', () => setRegionOptions(countryEl.value, regionEl));
      marketToggle.addEventListener('change', () => {
        const enabled = marketToggle.checked;
        marketTypeEl.disabled = !enabled;
        coveredEl.disabled = !enabled;
        marketYearEl.disabled = !enabled;
        if (!enabled) {
          marketTypeEl.value = '';
          coveredEl.value = '';
          marketYearEl.value = '';
        } else if (!marketYearEl.value) {
          marketYearEl.value = String(CURRENT_YEAR);
        }
      });

      const setStatus = (msg) => {
        if (statusEl) statusEl.textContent = msg;
      };

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        setStatus('');
        const country = countryEl.value;
        const region = regionEl.value;
        const month = parseInt(monthEl.value, 10);
        const year = parseInt(yearEl.value, 10);
        const kwh = parseFloat(kwhEl.value);
        const marketEnabled = marketToggle.checked;
        const marketType = marketTypeEl.value;
        const coveredKwh = parseFloat(coveredEl.value || '0');
        const marketYear = parseInt(marketYearEl.value || '0', 10);

        if (!country || !region || !month || !year || !Number.isFinite(kwh) || kwh <= 0) {
          setStatus('Please complete all required fields.');
          return;
        }
        const site = sites.find((entry) => entry.country === country && entry.region === region);
        if (!site) {
          setStatus('Select a configured site.');
          return;
        }
        if (isFuturePeriod(year, month)) {
          setStatus('Future billing periods are not allowed.');
          return;
        }
        if (marketEnabled) {
          if (!marketType || !Number.isFinite(coveredKwh) || coveredKwh < 0 || !marketYear) {
            setStatus('Provide instrument type, covered kWh, and reporting year.');
            return;
          }
          if (marketYear > CURRENT_YEAR) {
            setStatus('Reporting year cannot be in the future.');
            return;
          }
          if (coveredKwh > kwh) {
            setStatus('Covered kWh cannot exceed total kWh.');
            return;
          }
        }

        const session = await getSession();
        if (!session) {
          window.location.href = 'index.html';
          return;
        }
        const companyId = await getCompanyId(session);
        if (!companyId) {
          setStatus('Company profile missing. Add it from the main page.');
          return;
        }

        const factorData = getEmissionFactor(country, region, year);
        const factorValue = factorData.factor;
        const tonsLocation = kwh * factorValue;
        const tonsMarket = marketEnabled ? Math.max(kwh - coveredKwh, 0) * factorValue : null;

        try {
          const payload = {
            user_id: session.user.id,
            company_id: companyId,
            site_id: site.id,
            period_year: year,
            period_month: month,
            kwh,
            location_based_emissions: tonsLocation,
            market_based_emissions: marketEnabled ? tonsMarket : null,
            market_instrument_type: marketEnabled ? marketType : null,
            covered_kwh: marketEnabled ? coveredKwh : null,
            emission_factor_value: factorValue,
            emission_factor_year: factorData.year,
            emission_factor_source: factorData.source,
            calc_country: country,
            calc_region: region
          };
          const { error } = await supabase
            .from('scope2_records')
            .upsert([payload], { onConflict: 'user_id,company_id,period_year,period_month,calc_country,calc_region' });
          if (error) {
            console.warn('Add record failed', error);
            setStatus(isPlanLimitError(error) ? PLAN_LIMIT_MESSAGE : 'Save failed. Please try again.');
            return;
          }
          await refreshRecords();
          closePanel();
        } catch (err) {
          console.warn('Add record error', err);
          setStatus('Save failed. Please try again.');
        }
      });
    };

    const buildBulkPanel = () => `
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:12px;">
        <div>
          <div style="font-weight:700;font-size:1.05rem;">Bulk add records</div>
          <div style="color:#4b5563;font-size:0.95rem;">Add multiple months at once (market-based optional per row).</div>
        </div>
        <button type="button" class="btn secondary" data-close-panel style="padding:8px 10px;">×</button>
      </div>
      <div class="panel-hint">Enter the month electricity was consumed, not when the bill was paid. Locations not in Settings are disabled.</div>
      <form id="bulk-form" class="panel-form">
        <div id="bulk-rows"></div>
        <div class="panel-actions">
          <button type="button" class="btn secondary" id="bulk-add-row">Add row</button>
          <button type="submit" class="btn primary">Save rows</button>
        </div>
        <p class="panel-status" id="bulk-status"></p>
      </form>
    `;

    const createBulkRow = () => {
      const row = document.createElement('div');
      row.className = 'bulk-row';
      row.innerHTML = `
        <div class="panel-row">
          <label>
            Country / region
            <select data-field="country"></select>
          </label>
          <label>
            State / region
            <select data-field="region"></select>
          </label>
        </div>
        <div class="panel-row">
          <label>
            Billing month
            <select data-field="month"></select>
          </label>
          <label>
            Billing year
            <select data-field="year"></select>
          </label>
        </div>
        <div class="panel-row">
          <label>
            Electricity (kWh)
            <input type="number" data-field="kwh" min="1" step="any" placeholder="e.g., 1200" />
          </label>
          <label>
            Instrument type (market-based Scope 2)
            <select data-field="marketType">
              <option value="">None</option>
              <option value="REC">REC</option>
              <option value="PPA">PPA</option>
              <option value="Green tariff">Green tariff</option>
            </select>
          </label>
        </div>
        <div class="panel-row">
          <label>
            Covered electricity (kWh)
            <input type="number" data-field="covered" min="0" step="any" placeholder="0" />
          </label>
          <label>
            Reporting year (market-based Scope 2)
            <select data-field="marketYear"></select>
          </label>
        </div>
        <div class="bulk-row-actions">
          <button type="button" class="btn secondary" data-remove-row>Remove row</button>
        </div>
      `;
      const countryEl = row.querySelector('[data-field="country"]');
      const regionEl = row.querySelector('[data-field="region"]');
      const monthEl = row.querySelector('[data-field="month"]');
      const yearEl = row.querySelector('[data-field="year"]');
      const marketYearEl = row.querySelector('[data-field="marketYear"]');
      if (countryEl && regionEl && monthEl && yearEl && marketYearEl) {
        populateCountries(countryEl);
        populateMonths(monthEl);
        populateYears(yearEl);
        populateYears(marketYearEl);
        setRegionOptions(countryEl.value, regionEl);
        countryEl.addEventListener('change', () => setRegionOptions(countryEl.value, regionEl));
      }
      const removeBtn = row.querySelector('[data-remove-row]');
      if (removeBtn) {
        removeBtn.addEventListener('click', () => row.remove());
      }
      return row;
    };

    const openBulkPanel = () => {
      openPanel(buildBulkPanel());
      const rowsEl = recordPanel?.querySelector('#bulk-rows');
      const addRowBtn = recordPanel?.querySelector('#bulk-add-row');
      const form = recordPanel?.querySelector('#bulk-form');
      const statusEl = recordPanel?.querySelector('#bulk-status');
      if (!rowsEl || !addRowBtn || !form) return;

      if (!sitesLoaded) {
        if (statusEl) statusEl.textContent = 'Loading site list…';
        form.querySelector('button[type="submit"]').disabled = true;
      } else if (!sites.length) {
        if (statusEl) statusEl.textContent = 'Add at least one site in Settings before creating records.';
        form.querySelector('button[type="submit"]').disabled = true;
      }

      for (let i = 0; i < 3; i += 1) {
        rowsEl.appendChild(createBulkRow());
      }
      addRowBtn.addEventListener('click', () => {
        rowsEl.appendChild(createBulkRow());
      });

      const setStatus = (msg) => {
        if (statusEl) statusEl.textContent = msg;
      };

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        setStatus('');
        const rows = Array.from(rowsEl.querySelectorAll('.bulk-row'));
        if (!rows.length) {
          setStatus('Add at least one row.');
          return;
        }

        const session = await getSession();
        if (!session) {
          window.location.href = 'index.html';
          return;
        }
        const companyId = await getCompanyId(session);
        if (!companyId) {
          setStatus('Company profile missing. Add it from the main page.');
          return;
        }

        const payloads = [];
        const errors = [];

        rows.forEach((row, idx) => {
          const country = row.querySelector('[data-field="country"]')?.value || '';
          const region = row.querySelector('[data-field="region"]')?.value || '';
          const month = parseInt(row.querySelector('[data-field="month"]')?.value || '0', 10);
          const year = parseInt(row.querySelector('[data-field="year"]')?.value || '0', 10);
          const kwh = parseFloat(row.querySelector('[data-field="kwh"]')?.value || '');
          const marketType = row.querySelector('[data-field="marketType"]')?.value || '';
          const coveredKwh = parseFloat(row.querySelector('[data-field="covered"]')?.value || '0');
          const marketYear = parseInt(row.querySelector('[data-field="marketYear"]')?.value || '0', 10);

          const hasAny = [country, region, month, year, kwh, marketType, coveredKwh, marketYear].some((v) => v);
          if (!hasAny) return;

          if (!country || !region || !month || !year || !Number.isFinite(kwh) || kwh <= 0) {
            errors.push(`Row ${idx + 1}: complete country, region, month, year, and kWh.`);
            return;
          }
          const site = sites.find((entry) => entry.country === country && entry.region === region);
          if (!site) {
            errors.push(`Row ${idx + 1}: select a configured site.`);
            return;
          }
          if (isFuturePeriod(year, month)) {
            errors.push(`Row ${idx + 1}: future billing periods are not allowed.`);
            return;
          }
          if (marketType) {
            if (!Number.isFinite(coveredKwh) || coveredKwh < 0 || !marketYear) {
              errors.push(`Row ${idx + 1}: provide covered kWh and reporting year for market-based.`);
              return;
            }
            if (marketYear > CURRENT_YEAR) {
              errors.push(`Row ${idx + 1}: reporting year cannot be in the future.`);
              return;
            }
            if (coveredKwh > kwh) {
              errors.push(`Row ${idx + 1}: covered kWh cannot exceed total kWh.`);
              return;
            }
          } else if (coveredKwh > 0 || marketYear) {
            errors.push(`Row ${idx + 1}: select an instrument type or clear market fields.`);
            return;
          }

          const factorData = getEmissionFactor(country, region, year);
          const factorValue = factorData.factor;
          const tonsLocation = kwh * factorValue;
          const tonsMarket = marketType ? Math.max(kwh - coveredKwh, 0) * factorValue : null;

          payloads.push({
            user_id: session.user.id,
            company_id: companyId,
            site_id: site.id,
            period_year: year,
            period_month: month,
            kwh,
            location_based_emissions: tonsLocation,
            market_based_emissions: marketType ? tonsMarket : null,
            market_instrument_type: marketType || null,
            covered_kwh: marketType ? coveredKwh : null,
            emission_factor_value: factorValue,
            emission_factor_year: factorData.year,
            emission_factor_source: factorData.source,
            calc_country: country,
            calc_region: region
          });
        });

        if (errors.length) {
          setStatus(errors[0]);
          return;
        }
        if (!payloads.length) {
          setStatus('Add at least one complete row.');
          return;
        }

        try {
          const { error } = await supabase
            .from('scope2_records')
            .upsert(payloads, { onConflict: 'user_id,company_id,period_year,period_month,calc_country,calc_region' });
          if (error) {
            console.warn('Bulk add failed', error);
            setStatus(isPlanLimitError(error) ? PLAN_LIMIT_MESSAGE : 'Save failed. Please try again.');
            return;
          }
          await refreshRecords();
          closePanel();
        } catch (err) {
          console.warn('Bulk add error', err);
          setStatus('Save failed. Please try again.');
        }
      });
    };

    // Wire slide-out Edit/Delete callbacks
    window.onRecordDelete = async (id) => {
      const confirmDelete = confirm('Delete this record?');
      if (!confirmDelete) return;
      if (supabase) {
        const { error } = await supabase.from('scope2_records').delete().eq('id', id);
        if (error) {
          alert('Delete failed. Please try again.');
          return;
        }
      }
      deleteLocalRecord(id);
      if (window.renderRecords) window.renderRecords('recordsTable');
      if (window.renderCarbonSummary) window.renderCarbonSummary();
      if (window.renderCarbonReminders) window.renderCarbonReminders();
      closePanel();
    };

    window.onRecordEdit = async (id) => {
      const records = window.loadRecords ? window.loadRecords() : [];
      const record = records.find((r) => String(r.id) === String(id));
      if (!record) {
        alert('Record not found.');
        return;
      }
      openPanel(buildEditPanel(record));
      const form = recordPanel?.querySelector('#edit-record-form');
      const kwhEl = recordPanel?.querySelector('#edit-kwh');
      const statusEl = recordPanel?.querySelector('#edit-status');
      if (!form || !kwhEl) return;
      const setStatus = (msg) => { if (statusEl) statusEl.textContent = msg; };

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        setStatus('');
        const kwhVal = parseFloat(kwhEl.value);
        if (!kwhVal || kwhVal <= 0) {
          setStatus('Enter a valid kWh.');
          return;
        }
        const factorVal = Number(record.emission_factor_value || 0);
        const tonsLocation = kwhVal * factorVal;
        const covered = Number(record.covered_kwh || 0);
        const tonsMarket = record.market_based_emissions != null
          ? Math.max(kwhVal - covered, 0) * factorVal
          : null;

        if (supabase) {
          const { error } = await supabase.from('scope2_records').update({
            kwh: kwhVal,
            location_based_emissions: tonsLocation,
            market_based_emissions: tonsMarket,
            covered_kwh: record.covered_kwh || null
          }).eq('id', id);
          if (error) {
            setStatus('Save failed. Please try again.');
            return;
          }
        }
        const updated = records.map((r) => String(r.id) === String(id)
          ? { ...r, kwh: kwhVal, location_based_emissions: tonsLocation, market_based_emissions: tonsMarket }
          : r);
        if (window.saveRecords) window.saveRecords(updated);
        if (window.renderRecords) window.renderRecords('recordsTable');
        if (window.renderCarbonSummary) window.renderCarbonSummary();
        if (window.renderCarbonReminders) window.renderCarbonReminders();
        closePanel();
      });
    };

    const attachHandlers = () => {
      if (recordsTable) {
        recordsTable.addEventListener('click', (e) => {
          const btn = e.target.closest('button[data-action]');
          if (!btn) return;
          const id = btn.getAttribute('data-id');
          const action = btn.getAttribute('data-action');
          if (action === 'view' && window.openRecordPanel) {
            window.openRecordPanel(id, recordPanel?.id || 'recordPanel');
          }
        });
      }
      if (signoutBtn) {
        signoutBtn.addEventListener('click', async (e) => {
          e.preventDefault();
          if (supabase) {
            try { await supabase.auth.signOut(); } catch (err) { console.warn('Log out failed', err); }
          }
          window.location.href = 'index.html';
        });
      }
      if (exportBtn) {
        exportBtn.addEventListener('click', async () => {
          await exportFiltered();
        });
      }
      if (addBtn) {
        addBtn.addEventListener('click', () => {
          openAddPanel();
        });
      }
      if (bulkBtn) {
        bulkBtn.addEventListener('click', () => {
          openBulkPanel();
        });
      }
    };

    (async () => {
      attachHandlers();
      document.querySelectorAll('.records-filters select').forEach((el) => {
        el.addEventListener('change', () => {
          el.dataset.userSet = 'true';
          if (window.renderRecords) window.renderRecords('recordsTable');
          if (window.renderCarbonSummary) window.renderCarbonSummary();
          if (window.renderCarbonReminders) window.renderCarbonReminders();
        });
      });
      await initSupabase();
      if (supabase) {
        await refreshRecords();
        const session = await getSession();
        if (session) {
          entitlements = await loadEntitlements(session);
          updateScope3Nav();
          updateNavBrand('', entitlements?.tier);
          await loadCompanyPreference(session);
        } else {
          entitlements = null;
          updateScope3Nav();
          updateNavBrand('', '');
        }
        applyRecordGate();
        if (window.renderRecords) window.renderRecords('recordsTable');
        if (window.renderCarbonSummary) window.renderCarbonSummary();
        if (window.renderCarbonReminders) window.renderCarbonReminders();
        supabase.auth.onAuthStateChange(async (_event, session) => {
          if (_event === 'SIGNED_IN' || _event === 'TOKEN_REFRESHED' || _event === 'SIGNED_OUT') {
            await refreshRecords();
            if (session) {
              entitlements = await loadEntitlements(session);
              updateScope3Nav();
              await loadCompanyPreference(session);
            } else {
              sites = [];
              hqSite = null;
              entitlements = null;
              updateScope3Nav();
              applyRecordGate();
            }
            applyRecordGate();
            if (window.renderRecords) window.renderRecords('recordsTable');
            if (window.renderCarbonSummary) window.renderCarbonSummary();
            if (window.renderCarbonReminders) window.renderCarbonReminders();
          }
        });
      } else {
        showMessage('History unavailable while offline.');
      }
    })();
  </script>
  <script>
    (function initMobileNav() {
      const toggle = document.getElementById('mobile-nav-toggle');
      const overlay = document.getElementById('mobile-nav-overlay');
      if (!toggle || !overlay) return;
      const closeNav = () => document.body.classList.remove('nav-open');
      toggle.addEventListener('click', () => {
        document.body.classList.toggle('nav-open');
      });
      overlay.addEventListener('click', closeNav);
      document.querySelectorAll('.nav-item').forEach((link) => {
        link.addEventListener('click', closeNav);
      });
    })();
  </script>
</body>
</html>
