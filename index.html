<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CarbonWise | TurboTax for Carbon Reporting</title>
  <style>
    :root {
      --ink: #0f172a;
      --muted: #4b5563;
      --line: #e5e7eb;
      --card: #ffffff;
      --accent: #0f766e;
      --accent-soft: #e0f2f1;
      --bg: #f7f8fb;
      font-family: "SF Pro Display", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--ink);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--bg);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
    }
    .shell {
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 20px 80px;
    }
    header {
      padding: 70px 20px 40px;
      background: radial-gradient(circle at 20% 25%, rgba(224, 242, 241, 0.35), transparent 28%), #0f172a; /* soften highlight for mobile comfort */
      color: #f8fafc;
      text-align: left;
    }
    header .shell { padding-bottom: 30px; }
    h1 {
      margin: 0 0 14px;
      font-size: clamp(34px, 4vw, 46px);
      letter-spacing: -0.015em;
      line-height: 1.2;
    }
    .subhead {
      font-size: 1.15rem;
      color: #dbeafe;
      max-width: 680px;
      margin: 0 0 18px;
    }
    .cta-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 14px 18px;
      border-radius: 12px;
      border: 1px solid transparent;
      font-weight: 700;
      text-decoration: none;
      cursor: pointer;
      color: inherit;
    }
    .btn.primary {
      background: #22c55e;
      color: #0f172a;
    }
    .btn.secondary {
      background: #f8fafc;
      border-color: #cbd5e1;
      color: #0f172a;
    }
    .top-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }
    .meta-line {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 12px;
      color: #cbd5e1;
      font-size: 0.98rem;
    }
    .hero-clarifier {
      color: #cbd5e1;
      font-size: 0.95rem;
      margin: 6px 0 16px;
    }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: #e0f2f1;
      color: #0f766e;
      border-radius: 999px;
      font-weight: 700;
      font-size: 0.95rem;
    }
    h2 {
      margin: 0 0 10px;
      font-size: 1.6rem;
      letter-spacing: -0.01em;
    }
    p { margin: 0 0 12px; color: var(--muted); }
    section {
      margin-top: 26px;
      padding: 22px 20px;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 16px;
      box-shadow: 0 16px 44px rgba(15, 23, 42, 0.08);
    }
    .tag {
      display: inline-block;
      padding: 6px 10px;
      background: #e0f2f1;
      color: #0f766e;
      border-radius: 999px;
      font-weight: 600;
      font-size: 0.9rem;
    }
    .stack { display: grid; gap: 12px; }
    .grid-3 {
      display: grid;
      gap: 14px;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    }
    ul { padding-left: 18px; margin: 0; color: var(--muted); }
    .muted { color: var(--muted); }
    .small { font-size: 0.95rem; }
    label {
      font-weight: 600;
      display: block;
      margin-bottom: 6px;
    }
    input, select {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid var(--line);
      font-size: 1rem;
      font-family: inherit;
      background: #fff;
    }
    .hint {
      font-size: 0.9rem;
      color: var(--muted);
      margin-top: 4px;
    }
    .two-col {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    }
    .notice {
      background: #f8fafc;
      border: 1px solid #cbd5e1;
      padding: 12px;
      border-radius: 10px;
      color: var(--muted);
      font-size: 0.95rem;
    }
    .result {
      display: none;
    }
    .result.active {
      display: grid;
      gap: 14px;
    }
    .example {
      background: #f8fafc;
      border: 1px dashed #cbd5e1;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 12px;
      color: var(--muted);
    }
    .stat-box {
      background: #f8fafc;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 14px;
    }
    footer {
      margin-top: 24px;
      text-align: center;
      color: var(--muted);
      font-size: 0.95rem;
      line-height: 1.5;
    }
    @media (max-width: 640px) {
      header { padding-top: 54px; }
      h1 { font-size: 32px; }
      section { padding: 18px 16px; }
    }
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 999;
    }
    .modal.active { display: flex; }
    .modal-content {
      background: #fff;
      border-radius: 12px;
      padding: 18px;
      width: min(520px, 100%);
      border: 1px solid #e5e7eb;
      box-shadow: 0 16px 44px rgba(15, 23, 42, 0.15);
    }
    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 12px;
    }
    .history-list {
      display: grid;
      gap: 12px;
    }
    .history-item {
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 12px;
      background: #f8fafc;
    }
    details summary { cursor: pointer; font-weight: 600; }
    .table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    .table th, .table td {
      padding: 10px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
    }
    .table th {
      font-weight: 700;
      font-size: 0.95rem;
      color: var(--muted);
    }
    .table td {
      font-size: 0.95rem;
    }
    .btn.tab-active {
      border-color: #16a34a;
      color: #0f172a;
      background: #d1fae5;
      box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.15);
    }
    .company-badge {
      background: rgba(255, 255, 255, 0.12);
      color: #ffffff;
      padding: 8px 12px;
      border-radius: 999px;
      font-weight: 700;
      border: 1px solid rgba(255,255,255,0.25);
    }
    .slide-panel {
      position: fixed;
      top: 0;
      right: 0;
      width: min(420px, 100%);
      height: 100%;
      background: #fff;
      box-shadow: -8px 0 24px rgba(15, 23, 42, 0.1);
      border-left: 1px solid #e5e7eb;
      padding: 16px;
      overflow-y: auto;
      transform: translateX(100%);
      transition: transform 0.25s ease;
      z-index: 1000;
    }
    .slide-panel.active {
      transform: translateX(0);
    }
    .hidden { display: none; }
  </style>
</head>
<body>
  <header>
    <div class="shell">
      <div class="top-row">
        <div class="tag">CarbonWise</div>
        <span id="header-company" class="company-badge" style="display:none;"></span>
        <a class="btn secondary" id="header-records" href="records.html">My Records</a>
        <button class="btn secondary" id="header-signin">Sign in</button>
        <button class="btn secondary" id="header-signout" style="display:none;">Sign out</button>
      </div>
      <h1>Carbon reporting for small teams — without the complexity</h1>
      <p class="subhead">Carbon calculations in minutes, plain-English, no consultants/spreadsheets/data lock-in.</p>
      <p class="hero-clarifier">Built for growing companies that need audit-ready carbon reporting.</p>
      <div class="cta-row">
        <a class="btn primary" href="#calculator">Calculate My Emissions</a>
        <a class="btn secondary" href="#how">See how it works</a>
      </div>
      <div class="meta-line">
        <span>Privacy-first · No logins required</span>
        <span>Aligned with GHG Protocol</span>
        <span>Scope 1 &amp; Scope 2 focused</span>
      </div>
    </div>
  </header>

  <div class="shell">
    <section id="problem">
      <h2>Carbon reporting is confusing by design.</h2>
      <p>Endless portals, vague emission factors, and compliance jargon make small teams stall. CarbonWise removes the noise so you can move.</p>
      <p>We ask only what’s necessary, use public factors (EPA/DEFRA), and explain results in plain English.</p>
    </section>

    <section id="how">
      <h2>How CarbonWise works</h2>
      <div class="grid-3">
        <div>
          <strong>1) You enter electricity usage</strong>
          <p class="muted">Country/region, billing month, and kWh. Nothing personal.</p>
        </div>
        <div>
          <strong>2) CarbonWise applies public emission factors</strong>
          <p class="muted">Transparent, government-issued factors (EPA/DEFRA) — no black boxes.</p>
        </div>
        <div>
          <strong>3) You get a clear estimate</strong>
          <p class="muted">Location-based by default, with optional market-based if you opt in.</p>
        </div>
      </div>
    </section>

    <section id="calculator">
      <h2>Calculate your monthly Scope 2 emissions</h2>
      <p class="muted" style="margin-bottom:8px;">Start by telling us who you are so we can speak your language.</p>
      <form id="carbon-form" class="stack">
        <div class="two-col">
          <div>
            <label for="persona">Who are you?</label>
            <select id="persona" name="persona" required>
              <option value="">Select one</option>
              <option value="founder">Founder / operator</option>
              <option value="finance">Finance / accounting</option>
              <option value="advisor">Fractional CFO / advisor</option>
              <option value="other">Other</option>
            </select>
            <div class="hint">We tailor the explanation tone. No personal data stored.</div>
          </div>
          <div>
            <label for="country">Country / region</label>
            <select id="country" name="country" required>
              <option value="">Select country</option>
              <option value="US">United States</option>
              <option value="CA">Canada</option>
              <option value="UK">United Kingdom</option>
              <option value="AU">Australia</option>
              <option value="SG">Singapore</option>
              <option value="NZ">New Zealand</option>
            </select>
            <div class="hint">We match public grid factors; you can adjust later.</div>
          </div>
        </div>
        <div class="two-col">
          <div>
            <label for="month">Billing month</label>
            <select id="month" name="month" required>
              <option value="">Select month</option>
              <option>January</option><option>February</option><option>March</option><option>April</option>
              <option>May</option><option>June</option><option>July</option><option>August</option>
              <option>September</option><option>October</option><option>November</option><option>December</option>
            </select>
            <div class="hint">We calculate one month at a time for clarity.</div>
          </div>
          <div>
            <label for="year">Billing year</label>
            <select id="year" name="year" required></select>
            <div class="hint">We show only years up to the current year; future periods are blocked.</div>
          </div>
        </div>
        <div class="two-col">
          <div>
            <label for="kwh">Electricity used (kWh)</label>
            <input type="number" id="kwh" name="kwh" min="1" step="any" required placeholder="e.g., 1200" />
            <div class="hint">Found on your statement as total kWh for the month.</div>
          </div>
          <div>
            <label for="region">State / region</label>
            <select id="region" name="region" required>
              <option value="">Select state / province</option>
            </select>
            <div class="hint">Choose your state (US) or province/territory (Canada). Used only to contextualize results.</div>
          </div>
        </div>
        <div class="notice">
          No uploads. No accounts. We only use the fields above to calculate a Scope 2 (location-based) estimate with EPA/DEFRA factors. This is informational, not a filing.
        </div>
        <div class="cta-row" style="justify-content:flex-start;">
          <button type="submit" class="btn primary">See my emissions in minutes</button>
        </div>
        <div class="notice" style="margin-top:10px;">
          <label style="display:flex;align-items:center;gap:8px;font-weight:600;">
            <input type="checkbox" id="market-toggle" style="width:auto;" />
            Include market-based Scope 2 (RECs / PPAs)
          </label>
          <div class="hint" style="margin-top:6px;">Market-based emissions reflect purchased renewable energy instruments such as RECs or PPAs. Optional and off by default.</div>
          <div id="market-fields" class="stack" style="margin-top:10px; display:none;">
            <div class="two-col">
              <div>
                <label for="market-type">Instrument type</label>
                <select id="market-type" name="market-type">
                  <option value="">Select instrument</option>
                  <option value="REC">REC</option>
                  <option value="PPA">PPA</option>
                  <option value="Green tariff">Green tariff</option>
                </select>
                <div class="hint">We do not verify certificates or contracts; this is user-declared.</div>
              </div>
              <div>
                <label for="market-kwh">Covered electricity (kWh)</label>
                <input type="number" id="market-kwh" name="market-kwh" min="0" step="any" placeholder="e.g., 500" />
                <div class="hint">Portion of your kWh covered by RECs/PPAs. Uncovered kWh uses location-based factors.</div>
              </div>
            </div>
            <div class="two-col">
              <div>
                <label for="market-year">Reporting year (market-based)</label>
                <select id="market-year" name="market-year"></select>
                <div class="hint">Must be current or past years only.</div>
              </div>
            </div>
          </div>
        </div>
      </form>
      <!-- Trust strip anchors methodology without heavy enterprise vibe -->
      <div class="notice" style="margin-top:10px;">
        <strong>Methodology:</strong> GHG Protocol Scope 2 (location-based) • <strong>Emission factors:</strong> Public, government-issued data (year-stamped) • Estimates only — not legal, tax, or audit advice. Emission factors are updated as new data is released.
      </div>
    </section>

    <section id="results">
      <h2>Your estimate</h2>
      <!-- Pre-calculated example builds trust before interaction -->
      <div class="example">
        <strong>Example:</strong> 1,850 kWh → 1.42 metric tons CO₂e ≈ driving ~3,500 miles. Check your own month below.
      </div>
      <div id="result-container" class="result">
        <div class="grid-3">
          <div class="stat-box">
            <strong id="result-tons">—</strong><br />
            <span class="muted">Location-based (GHG Protocol)</span>
          </div>
          <div class="stat-box">
            <strong id="result-compare">—</strong><br />
            <span class="muted">Real-world comparison</span>
          </div>
          <div class="stat-box">
            <strong id="result-next">—</strong><br />
            <span class="muted">What to do next</span>
          </div>
          <div class="stat-box">
            <strong id="result-market">—</strong><br />
            <span class="muted">Market-based (GHG Protocol)</span>
          </div>
        </div>
        <div class="notice" id="calc-details"></div>
        <p class="muted" id="factor-mismatch" style="display:none;"></p>
        <p class="muted" id="interpretation"></p>
        <p class="muted" id="disclaimer"><strong>Disclaimer:</strong> CarbonWise provides informational estimates only. This is not legal, audit, or tax advice.</p>
        <div class="notice" id="market-disclaimer" style="display:none;">
          <strong>Market-based note:</strong> Market-based emissions depend on contractual instruments and are reported separately from location-based emissions. This estimate is based on user-declared renewable energy instruments. CarbonWise does not verify certificates or contracts and does not provide legal, tax, or audit advice.
          <div id="market-details" class="muted" style="margin-top:6px;"></div>
        </div>
        <div class="notice" id="compliance-helper">
          <strong>Compliance context (plain English):</strong><br />
          California SB-253 / SB-261 and EU CSRD apply to certain larger companies or those operating in those regions. Many small businesses are not required to report yet. This is high-level guidance only — not legal or audit advice.
        </div>
        <div class="cta-row" style="margin-top:12px; justify-content:flex-start;">
          <button type="button" class="btn primary" id="save-btn">Save & track history</button>
          <a href="records.html" class="btn secondary" id="history-link" data-page="records">My history</a>
          <button type="button" class="btn secondary" id="signout-btn" style="display:none;">Sign out</button>
        </div>
      </div>
      <div id="placeholder" class="muted">Your results will appear here after you calculate.</div>
    </section>

    <section id="history-section" class="page" data-page="records" style="display:none;">
      <div class="info-card" style="padding:16px;border:1px solid #e5e7eb;border-radius:12px;background:#f8fafc;">
        <div style="font-weight:700;">Your records now live in a dedicated page.</div>
        <a href="records.html" class="btn secondary" style="margin-top:10px; display:inline-flex;">Go to My Records →</a>
      </div>
    </section>

    <section id="privacy">
      <h2>Privacy & trust</h2>
      <ul>
        <li>No uploads. We never ask for bills or PDFs.</li>
        <li>No accounts or logins required to see results.</li>
        <li>No stored personal data. Inputs stay on your device.</li>
        <li>Emission factors from EPA / DEFRA — transparent and explainable.</li>
      </ul>
    </section>

    <section id="vision">
      <h2>CarbonWise is just getting started</h2>
      <p class="muted">We’re building the calm, obvious path to carbon reporting.</p>
      <div class="grid-3">
        <div>
          <strong>Monthly tracking</strong>
          <p class="muted">See trends over time and surface anomalies automatically.</p>
        </div>
        <div>
          <strong>Scope 1 & 2 coverage</strong>
          <p class="muted">Measure direct fuel use and electricity emissions — clearly and simply.</p>
        </div>
        <div>
          <strong>Exportable ESG summaries</strong>
          <p class="muted">Share clean, audit-friendly summaries with stakeholders.</p>
        </div>
      </div>
    </section>

    <footer>
      <p>CarbonWise exists to make carbon reporting obvious, private, and fast.</p>
      <p>Aligned with GHG Protocol Scope 2 (location-based). Factors: EPA / DEFRA.</p>
      <p><a href="mailto:hello@esgrise.com">Contact / feedback</a></p>
    </footer>
  </div>

  <!-- Auth + company modal -->
  <div class="modal" id="auth-modal">
    <div class="modal-content">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
        <h3 id="auth-modal-title" style="margin:0;">Sign in to save & track history</h3>
        <button type="button" class="btn secondary" id="auth-close" aria-label="Close auth modal" style="padding:8px 10px;">×</button>
      </div>
      <p class="muted" id="auth-modal-desc">Sign in to save results and track your history. Calculations work without an account.</p>

      <div class="stack">
        <div class="cta-row" style="justify-content:flex-start;gap:8px;">
          <button type="button" class="btn secondary" id="auth-tab-signin">Sign in</button>
          <button type="button" class="btn secondary" id="auth-tab-signup">Create account</button>
        </div>

        <form id="auth-form-signin" class="stack" style="display:block;">
          <div>
            <label for="auth-email">Email</label>
            <input type="email" id="auth-email" required placeholder="you@example.com" />
          </div>
          <div>
            <label for="auth-password">Password</label>
            <input type="password" id="auth-password" required placeholder="••••••••" autocomplete="current-password" />
          </div>
          <div class="modal-actions" style="justify-content:space-between;flex-wrap:wrap;gap:8px;">
            <div style="display:flex;gap:8px;align-items:center;">
              <button type="button" class="btn secondary" id="auth-cancel">Cancel</button>
              <button type="button" class="btn secondary" id="auth-forgot">Forgot password?</button>
            </div>
            <button type="submit" class="btn primary" id="auth-submit">Sign in</button>
          </div>
          <button type="button" class="btn secondary" id="auth-passcode" style="width:auto;">Use email passcode instead</button>
          <p class="muted small" id="auth-status"></p>
          <p class="muted small" id="auth-status-passcode" style="display:none;">We’ll email you a secure one-time sign-in link.</p>
          <p class="muted small" id="auth-status-passcode-hint" style="display:none;">After clicking the email link, continue in that tab. Refresh here if needed.</p>
        </form>

        <form id="auth-form-signup" class="stack" style="display:none;">
          <div>
            <label for="auth-email-signup">Email</label>
            <input type="email" id="auth-email-signup" required placeholder="you@example.com" />
          </div>
          <div>
            <label for="auth-password-signup">Password</label>
            <input type="password" id="auth-password-signup" required placeholder="••••••••" autocomplete="new-password" />
          </div>
          <div>
            <label for="signup-company-name">Company name</label>
            <input type="text" id="signup-company-name" required placeholder="Acme Co." />
          </div>
          <div class="two-col">
            <div>
              <label for="signup-company-country">Company country / region</label>
              <select id="signup-company-country" required>
                <option value="">Select country</option>
                <option value="US">United States</option>
                <option value="CA">Canada</option>
                <option value="UK">United Kingdom</option>
                <option value="AU">Australia</option>
                <option value="SG">Singapore</option>
                <option value="NZ">New Zealand</option>
              </select>
            </div>
            <div>
              <label for="signup-company-region">State / region (optional)</label>
              <select id="signup-company-region">
                <option value="">Select state / province (optional)</option>
              </select>
            </div>
          </div>
          <div class="modal-actions" style="justify-content:flex-end;">
            <button type="submit" class="btn primary" id="auth-submit-signup">Create account</button>
          </div>
          <p class="muted small" id="auth-status-signup"></p>
          <p class="muted small">Check your email to confirm your account before signing in.</p>
        </form>

        <form id="auth-form-reset" class="stack" style="display:none;">
          <div>
            <label for="auth-email-reset">Email</label>
            <input type="email" id="auth-email-reset" required placeholder="you@example.com" />
          </div>
          <div class="modal-actions" style="justify-content:flex-end;">
            <button type="submit" class="btn primary" id="auth-submit-reset">Send reset link</button>
          </div>
          <p class="muted small" id="auth-status-reset">We’ve sent you a password reset link.</p>
        </form>

        <form id="auth-form-update-password" class="stack" style="display:none;">
          <div>
            <label for="auth-password-new">New password</label>
            <input type="password" id="auth-password-new" required placeholder="Set a new password" autocomplete="new-password" />
          </div>
          <div class="modal-actions" style="justify-content:flex-end;">
            <button type="submit" class="btn primary" id="auth-submit-update">Update password</button>
          </div>
          <p class="muted small" id="auth-status-update">Enter a new password to complete reset.</p>
        </form>

        <form id="company-form" class="stack" style="display:none;">
          <div>
            <label for="company-name">Company name</label>
            <input type="text" id="company-name" required placeholder="Acme Co." />
          </div>
          <div class="two-col">
            <div>
              <label for="company-country">Company country</label>
              <select id="company-country" required>
                <option value="">Select country</option>
                <option value="US">United States</option>
                <option value="CA">Canada</option>
                <option value="UK">United Kingdom</option>
                <option value="AU">Australia</option>
                <option value="SG">Singapore</option>
                <option value="NZ">New Zealand</option>
              </select>
            </div>
            <div>
              <label for="company-region">Region / state (optional)</label>
              <input type="text" id="company-region" placeholder="e.g., California" />
            </div>
          </div>
          <div class="modal-actions">
            <button type="button" class="btn secondary" id="company-back">Back</button>
            <button type="submit" class="btn primary" id="company-submit">Save company</button>
          </div>
          <p class="muted small">No bill uploads required. We only store the usage values you enter.</p>
        </form>
      </div>
    </div>
  </div>

  <!-- View record modal -->
  <div class="modal" id="view-modal">
    <div class="modal-content">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
        <h3 style="margin:0;">Record details</h3>
        <button type="button" class="btn secondary" id="view-close" aria-label="Close view modal" style="padding:8px 10px;">×</button>
      </div>
      <div class="stack" id="view-body" style="margin-top:10px;"></div>
      <p class="muted small" style="margin-top:10px;">Location-based Scope 2 calculation aligned with the GHG Protocol.</p>
    </div>
  </div>

  <!-- Edit record modal -->
  <div class="modal" id="edit-modal">
    <div class="modal-content">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
        <h3 style="margin:0;">Edit record</h3>
        <button type="button" class="btn secondary" id="edit-close" aria-label="Close edit modal" style="padding:8px 10px;">×</button>
      </div>
      <form id="edit-form" class="stack" style="margin-top:10px;">
        <div class="two-col">
          <div>
            <label>Billing period</label>
            <input type="text" id="edit-period" readonly />
          </div>
          <div>
            <label>Factor source / year</label>
            <input type="text" id="edit-factor" readonly />
          </div>
        </div>
        <div>
          <label for="edit-kwh">Electricity used (kWh)</label>
          <input type="number" id="edit-kwh" min="1" step="any" required />
        </div>
        <div class="two-col">
          <div>
            <label for="edit-market-type">Instrument type (optional)</label>
            <select id="edit-market-type">
              <option value="">Select instrument</option>
              <option value="REC">REC</option>
              <option value="PPA">PPA</option>
              <option value="Green tariff">Green tariff</option>
            </select>
          </div>
          <div>
            <label for="edit-covered">Covered electricity (kWh)</label>
            <input type="number" id="edit-covered" min="0" step="any" placeholder="0" />
          </div>
        </div>
        <p class="muted small">This update recalculates emissions using the same methodology.</p>
        <div class="modal-actions">
          <button type="submit" class="btn primary" id="edit-save">Save</button>
        </div>
        <p class="muted small" id="edit-status"></p>
      </form>
    </div>
  </div>

  <!-- Slide-out record detail panel -->
  <div id="recordPanel" class="slide-panel hidden" aria-live="polite"></div>

  <script type="module">
    import { EMISSION_FACTORS, GLOBAL_FALLBACK } from './data/emission-factors.js';
    import { loadRecords, saveRecords, renderRecords, openRecord } from './js/records.js';
    // Configurable emission factors (metric tons CO2e per kWh)
    // Emission factors imported from a versioned, append-only dataset for easy updates without touching UI/logic.

    // Valid regions to keep entries clean and trusted
    const REGION_OPTIONS = {
      US: [
        "Alabama","Alaska","Arizona","Arkansas","California","Colorado","Connecticut","Delaware","District of Columbia",
        "Florida","Georgia","Hawaii","Idaho","Illinois","Indiana","Iowa","Kansas","Kentucky","Louisiana","Maine",
        "Maryland","Massachusetts","Michigan","Minnesota","Mississippi","Missouri","Montana","Nebraska","Nevada",
        "New Hampshire","New Jersey","New Mexico","New York","North Carolina","North Dakota","Ohio","Oklahoma",
        "Oregon","Pennsylvania","Rhode Island","South Carolina","South Dakota","Tennessee","Texas","Utah","Vermont",
        "Virginia","Washington","West Virginia","Wisconsin","Wyoming"
      ],
      CA: [
        "Alberta","British Columbia","Manitoba","New Brunswick","Newfoundland and Labrador","Northwest Territories",
        "Nova Scotia","Nunavut","Ontario","Prince Edward Island","Quebec","Saskatchewan","Yukon"
      ],
      UK: [
        "England","Northern Ireland","Scotland","Wales"
      ],
      AU: [
        "New South Wales","Victoria","Queensland","Western Australia","South Australia",
        "Tasmania","Australian Capital Territory","Northern Territory"
      ],
      SG: [
        "Singapore"
      ],
      NZ: [
        "Auckland","Bay of Plenty","Canterbury","Gisborne","Hawke's Bay","Manawatu-Whanganui","Marlborough",
        "Nelson","Northland","Otago","Southland","Taranaki","Tasman","Waikato","Wellington","West Coast"
      ]
    };
    const CAR_MILES_PER_TON = 1 / 0.000404; // ~0.404 kg CO2e per mile
    const AVG_HOME_KWH_MONTH = 877; // US average monthly kWh per home

    const form = document.getElementById('carbon-form');
    const countryEl = document.getElementById('country');
    const regionEl = document.getElementById('region');
    const yearEl = document.getElementById('year');
    const monthEl = document.getElementById('month');
    const marketToggleEl = document.getElementById('market-toggle');
    const marketFields = document.getElementById('market-fields');
    const marketTypeEl = document.getElementById('market-type');
    const marketKwhEl = document.getElementById('market-kwh');
    const marketYearEl = document.getElementById('market-year');
    const resultContainer = document.getElementById('result-container');
    const placeholder = document.getElementById('placeholder');
    const tonsEl = document.getElementById('result-tons');
    const compareEl = document.getElementById('result-compare');
    const nextEl = document.getElementById('result-next');
    const calcDetailsEl = document.getElementById('calc-details');
    const interpretationEl = document.getElementById('interpretation');
    const factorMismatchEl = document.getElementById('factor-mismatch');
    const resultMarketEl = document.getElementById('result-market');
    const marketDisclaimer = document.getElementById('market-disclaimer');
    const marketDetails = document.getElementById('market-details');
    const saveBtn = document.getElementById('save-btn');
    // history-btn removed in favor of link
    const signoutBtn = document.getElementById('signout-btn');
    const historySection = document.getElementById('history-section');
    const recordsLoading = document.getElementById('records-loading');
    const recordsError = document.getElementById('records-error');
    const recordsTable = document.getElementById('records-table');
    const recordsTbody = document.getElementById('records-tbody');
    const recordsEmpty = document.getElementById('records-empty');
    const recordsSignout = document.getElementById('records-signout');
    const authModal = document.getElementById('auth-modal');
    const authEmail = document.getElementById('auth-email');
    const authCancel = document.getElementById('auth-cancel');
    const authStatus = document.getElementById('auth-status');
    const companyForm = document.getElementById('company-form');
    const companyName = document.getElementById('company-name');
    const companyCountry = document.getElementById('company-country');
    const companyRegion = document.getElementById('company-region');
    const companyBack = document.getElementById('company-back');
    const authModalTitle = document.getElementById('auth-modal-title');
    const authModalDesc = document.getElementById('auth-modal-desc');
    const authClose = document.getElementById('auth-close');
    const authTabSignin = document.getElementById('auth-tab-signin');
    const authTabSignup = document.getElementById('auth-tab-signup');
    const authFormSignin = document.getElementById('auth-form-signin');
    const authFormSignup = document.getElementById('auth-form-signup');
    const authFormReset = document.getElementById('auth-form-reset');
    const authPassword = document.getElementById('auth-password');
    const authEmailSignup = document.getElementById('auth-email-signup');
    const authPasswordSignup = document.getElementById('auth-password-signup');
    const authEmailReset = document.getElementById('auth-email-reset');
    const authStatusSignup = document.getElementById('auth-status-signup');
    const authStatusReset = document.getElementById('auth-status-reset');
    const authSubmitSignup = document.getElementById('auth-submit-signup');
    const authSubmitReset = document.getElementById('auth-submit-reset');
    const authForgot = document.getElementById('auth-forgot');
    const headerSignIn = document.getElementById('header-signin');
    const headerCompany = document.getElementById('header-company');
    const authFormUpdatePassword = document.getElementById('auth-form-update-password');
    const authPasswordNew = document.getElementById('auth-password-new');
    const authSubmitUpdate = document.getElementById('auth-submit-update');
    const authStatusUpdate = document.getElementById('auth-status-update');
    const authStatusPasscode = document.getElementById('auth-status-passcode');
    const authStatusPasscodeHint = document.getElementById('auth-status-passcode-hint');
    const authPasscodeBtn = document.getElementById('auth-passcode');
    const signupCompanyName = document.getElementById('signup-company-name');
    const signupCompanyCountry = document.getElementById('signup-company-country');
    const signupCompanyRegion = document.getElementById('signup-company-region');
    const viewModal = document.getElementById('view-modal');
    const viewBody = document.getElementById('view-body');
    const viewClose = document.getElementById('view-close');
    const editModal = document.getElementById('edit-modal');
    const editForm = document.getElementById('edit-form');
    const editClose = document.getElementById('edit-close');
    const editPeriod = document.getElementById('edit-period');
    const editFactor = document.getElementById('edit-factor');
    const editKwh = document.getElementById('edit-kwh');
    const editMarketType = document.getElementById('edit-market-type');
    const editCovered = document.getElementById('edit-covered');
    const editStatus = document.getElementById('edit-status');
    const headerSignout = document.getElementById('header-signout');
    const headerRecords = document.getElementById('header-records');
    const historyLink = document.getElementById('history-link');
    const pages = Array.from(document.querySelectorAll('.page'));

    const appState = {
      session: null,
      companyId: null,
      companyName: null,
      lastCalculation: null,
      saving: false,
      records: [],
      recordsLoading: false,
      recordsError: '',
      editingRecordId: null,
      authView: 'signin',
      authLoading: false,
      historyRevealed: false
    };

    // Supabase client config (replace placeholders or set window.SUPABASE_URL / window.SUPABASE_ANON_KEY)
    const SUPABASE_URL = window.SUPABASE_URL || 'https://yyzyyjxmoggrmqsgrlxc.supabase.co';
    const SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl5enl5anhtb2dncm1xc2dybHhjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxMTQ4MzMsImV4cCI6MjA4MTY5MDgzM30.BhnHmz9ADB52B_VcMdzvdyFiPvZFj_Q-jfjRqeAoQM4';
    const RESET_REDIRECT = 'https://www.esgrise.com/'; // must be a clean URL without hash
    let supabase = null;
    const initSupabaseClient = async () => {
      try {
        const { createClient } = await import('https://esm.sh/@supabase/supabase-js@2');
        supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        window.supabaseClient = supabase; // expose for debugging in console
      } catch (err) {
        console.warn('Supabase client failed to load from esm.sh; trying fallback CDN.', err);
        try {
          const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm');
          supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
          window.supabaseClient = supabase;
          console.info('Supabase loaded via jsDelivr fallback.');
        } catch (err2) {
          console.error('Supabase client failed to load; save/history disabled until online.', err2);
        }
      }
    };

    const TODAY = new Date();
    const CURRENT_YEAR = TODAY.getFullYear();
    const CURRENT_MONTH = TODAY.getMonth() + 1; // 1-12
    const MONTHS = ["January","February","March","April","May","June","July","August","September","October","November","December"];

    const formatNumber = (n, digits = 2) => Number(n).toLocaleString(undefined, { maximumFractionDigits: digits, minimumFractionDigits: digits });

    const normalizeKey = (str) => (str || "").trim().toUpperCase();

    // Populate year dropdown with current year and past years only
    const populateYears = (el) => {
      el.innerHTML = '';
      for (let y = CURRENT_YEAR; y >= 2024; y -= 1) {
        const opt = document.createElement('option');
        opt.value = y;
        opt.textContent = y;
        el.appendChild(opt);
      }
    };

    const refreshSessionDisplay = async () => {
      if (!supabase) return;
      const { data } = await supabase.auth.getSession();
      setSessionUI(data?.session || null);
      updateCompanyDisplay(data?.session || null);
    };

    // Records now live on records.html; keep a no-op to avoid undefined references.
    const refreshRecordsFromRemote = () => {};

    const redirectToRecords = () => {
      if (!window.location.pathname.endsWith('records.html')) {
        window.location.href = 'records.html';
      }
    };

    // Disable future months when current year is selected
    const syncMonthOptions = () => {
      const selectedYear = parseInt(yearEl.value, 10);
      const monthOptions = Array.from(monthEl.options).filter((o) => o.value);
      monthOptions.forEach((opt, idx) => {
        const monthNumber = idx + 1;
        opt.disabled = selectedYear === CURRENT_YEAR && monthNumber > CURRENT_MONTH;
      });
      // If current selection becomes invalid, reset to blank
      if (selectedYear === CURRENT_YEAR) {
        const selMonthIndex = monthEl.selectedIndex;
        const monthNumber = selMonthIndex > 0 ? selMonthIndex : 0;
        if (monthNumber > CURRENT_MONTH) {
          monthEl.value = '';
        }
      }
    };

    const setRegionOptions = (country) => {
      const opts = REGION_OPTIONS[country] || [];
      regionEl.innerHTML = '<option value="">Select state / province</option>';
      opts.forEach((name) => {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        regionEl.appendChild(opt);
      });
    };
    const setSignupRegionOptions = (country) => {
      const opts = REGION_OPTIONS[country] || [];
      signupCompanyRegion.innerHTML = '<option value="">Select state / province (optional)</option>';
      opts.forEach((name) => {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        signupCompanyRegion.appendChild(opt);
      });
    };

    // Select a FINAL factor version: prefer billing-year match, else most recent final year. Never overwrite historical records.
    const selectFinalFactor = (records, billingYear) => {
      const finals = (records || []).filter((r) => r.status === 'final');
      if (!finals.length) return null;
      const exact = finals.find((r) => r.year === billingYear);
      if (exact) return exact;
      return finals.reduce((latest, rec) => {
        if (!latest) return rec;
        return rec.year > latest.year ? rec : latest;
      }, null);
    };

    const setSessionUI = (session) => {
      // Minimal guard: rely only on header controls to avoid missing-node issues
      if (!headerSignIn || !headerCompany || !headerSignout || !headerRecords) return;
      appState.session = session;
      if (signoutBtn) signoutBtn.style.display = session ? 'inline-flex' : 'none';
      headerSignout.style.display = session ? 'inline-flex' : 'none';
      headerRecords.style.display = session ? 'inline-flex' : 'none';
      if (!session) {
        if (historySection) historySection.style.display = 'none';
        if (typeof recordsTable !== 'undefined' && recordsTable) recordsTable.style.display = 'none';
        if (typeof recordsEmpty !== 'undefined' && recordsEmpty) recordsEmpty.style.display = 'none';
        if (typeof recordsError !== 'undefined' && recordsError) recordsError.style.display = 'none';
        if (typeof recordsLoading !== 'undefined' && recordsLoading) recordsLoading.style.display = 'none';
        appState.companyId = null;
        appState.companyName = null;
        appState.historyRevealed = false;
        headerSignIn.style.display = 'inline-flex';
        headerCompany.style.display = 'none';
        headerSignout.style.display = 'none';
        headerRecords.style.display = 'none';
      } else {
        headerSignIn.style.display = 'none';
        headerCompany.style.display = appState.companyName || session?.user?.email ? 'inline' : 'none';
        // Default destination after login: show My Records info card
        if (!appState.historyRevealed && historySection) {
          showPage('records');
          historySection.scrollIntoView({ behavior: 'smooth' });
          appState.historyRevealed = true;
        }
      }
    };

    const updateCompanyDisplay = async (session) => {
      if (!headerCompany || !headerSignIn) return;
      if (!session) {
        headerSignIn.style.display = 'inline-flex';
        headerCompany.style.display = 'none';
        return;
      }
      headerSignIn.style.display = 'none';
      // Prefer cached company name; otherwise fetch first company for this user
      if (!appState.companyName && supabase) {
        const { data } = await supabase.from('companies').select('company_name').limit(1).single();
        if (data?.company_name) {
          appState.companyName = data.company_name;
        }
      }
      headerCompany.textContent = appState.companyName || session.user.email;
      headerCompany.style.display = 'inline';
    };

    const setAuthView = (view) => {
      appState.authView = view;
      authFormSignin.style.display = view === 'signin' ? 'block' : 'none';
      authFormSignup.style.display = view === 'signup' ? 'block' : 'none';
      authFormReset.style.display = view === 'reset' ? 'block' : 'none';
      authFormUpdatePassword.style.display = view === 'update' ? 'block' : 'none';
      companyForm.style.display = view === 'company' ? 'block' : 'none';
      // Tab highlighting
      authTabSignin.classList.toggle('tab-active', view === 'signin');
      authTabSignup.classList.toggle('tab-active', view === 'signup');
      authStatus.textContent = '';
      authStatusSignup.textContent = '';
      authStatusReset.textContent = 'We’ve sent you a password reset link.';
      authStatusUpdate.textContent = 'Enter a new password to complete reset.';
      authStatusPasscode.style.display = 'none';
      authStatusPasscode.textContent = '';
      authStatusPasscodeHint.style.display = 'none';
      if (view === 'signup') {
        setSignupRegionOptions(signupCompanyCountry.value);
      }
    };

    const openAuthModal = (view = 'signin') => {
      setAuthView(view);
      authModal.classList.add('active');
    };
    const closeAuthModal = () => {
      authModal.classList.remove('active');
      authFormSignin.reset();
      authFormSignup.reset();
      authFormReset.reset();
      authStatusPasscode.style.display = 'none';
      authStatusPasscode.textContent = '';
      authStatusPasscodeHint.style.display = 'none';
      authStatusPasscodeHint.textContent = 'After clicking the email link, continue in that tab. Refresh here if needed.';
    };

    const showHistorySection = () => {
      if (!appState.session) {
        authModalTitle.textContent = 'Sign in to view history';
        authModalDesc.textContent = 'Sign in to view saved records. Calculations work without an account.';
        openAuthModal('signin');
        return;
      }
      showPage('records');
      // Soft deprecation: no inline rendering; direct link provided in info card.
    };

    const showPage = (pageName) => {
      pages.forEach((page) => {
        page.style.display = page.dataset.page === pageName ? 'block' : 'none';
      });
    };

    const enterRecoveryMode = (session) => {
      // Supabase sets a temporary session for recovery; detect via session.user.recovery_sent_at or auth event.
      setSessionUI(session || appState.session);
      setAuthView('update');
      authModalTitle.textContent = 'Set a new password';
      authModalDesc.textContent = 'Complete your password reset to continue.';
      authModal.classList.add('active');
    };

    const initAuth = async () => {
      if (!supabase) return;
      const { data } = await supabase.auth.getSession();
      setSessionUI(data?.session || null);
      updateCompanyDisplay(data?.session || null);
      if (data?.session?.user?.recovery_sent_at) {
        enterRecoveryMode(data.session);
      }
      supabase.auth.onAuthStateChange((_event, session) => {
        setSessionUI(session);
        updateCompanyDisplay(session);
        if (session) {
          if (session.user?.recovery_sent_at || _event === 'PASSWORD_RECOVERY') {
            enterRecoveryMode(session);
            return;
          }
          if (appState.saving) {
            // Continue save flow after auth
            handleSaveFlow();
          }
          // Redirect only on new sign-in events to avoid bouncing when intentionally visiting the calculator
          if (_event === 'SIGNED_IN' && !window.location.pathname.endsWith('records.html')) {
            redirectToRecords();
          }
        }
      });
    };

    // Refresh session display when the user returns to the tab (helps with magic-link flows that open in a new tab)
    document.addEventListener('visibilitychange', async () => {
      if (document.visibilityState === 'visible' && supabase) {
        const { data } = await supabase.auth.getSession();
        setSessionUI(data?.session || null);
        updateCompanyDisplay(data?.session || null);
      }
    });

    authFormSignin.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!supabase) {
        authStatus.textContent = 'Supabase unavailable. Please retry when online.';
        return;
      }
      authStatus.textContent = 'Signing in...';
      const { error } = await supabase.auth.signInWithPassword({
        email: authEmail.value,
        password: authPassword.value
      });
      if (error) {
        authStatus.textContent = 'Could not sign in. Check your email or password, or confirm your account.';
        return;
      }
      authStatus.textContent = '';
      await refreshSessionDisplay();
      closeAuthModal();
      if (appState.saving) handleSaveFlow();
    });

    authFormSignup.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!supabase) {
        authStatusSignup.textContent = 'Supabase unavailable. Please retry when online.';
        return;
      }
      authStatusSignup.textContent = 'Creating account...';
      const { error, data } = await supabase.auth.signUp({
        email: authEmailSignup.value,
        password: authPasswordSignup.value
      });
      if (error) {
        authStatusSignup.textContent = 'Could not create account. Try a different email or check your password.';
        return;
      }
      if (data?.session?.user?.id) {
        const { error: companyErr } = await supabase.from('companies').insert({
          user_id: data.session.user.id,
          company_name: signupCompanyName.value.trim(),
          country: signupCompanyCountry.value,
          region: signupCompanyRegion.value || null
        });
        if (companyErr) {
          authStatusSignup.textContent = 'Account created. Check your email to confirm, then sign in. We will ask for company info after sign-in.';
          return;
        }
      }
      authStatusSignup.textContent = 'Check your email to confirm your account before signing in.';
    });

    authFormReset.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!supabase) {
        authStatusReset.textContent = 'Supabase unavailable. Please retry when online.';
        return;
      }
      authStatusReset.textContent = 'Sending reset link...';
      const { error } = await supabase.auth.resetPasswordForEmail(authEmailReset.value, { redirectTo: RESET_REDIRECT });
      if (error) {
        authStatusReset.textContent = 'Could not send reset link. Please try again.';
        return;
      }
      authStatusReset.textContent = 'We’ve sent you a password reset link.';
    });

    authCancel.addEventListener('click', () => {
      closeAuthModal();
    });
    authClose.addEventListener('click', () => {
      closeAuthModal();
    });

    authTabSignin.addEventListener('click', () => setAuthView('signin'));
    authTabSignup.addEventListener('click', () => setAuthView('signup'));
    authForgot.addEventListener('click', () => setAuthView('reset'));
    authPasscodeBtn.addEventListener('click', async () => {
      if (!supabase) {
        authStatusPasscode.style.display = 'block';
        authStatusPasscode.textContent = 'Supabase unavailable. Please retry when online.';
        authStatusPasscodeHint.style.display = 'none';
        return;
      }
      if (!authEmail.value) {
        authStatusPasscode.style.display = 'block';
        authStatusPasscode.textContent = 'Enter your email to receive a passcode link.';
        authStatusPasscodeHint.style.display = 'none';
        return;
      }
      authStatusPasscode.style.display = 'block';
      authStatusPasscode.textContent = 'Sending email passcode...';
      authStatusPasscodeHint.style.display = 'none';
      const { error } = await supabase.auth.signInWithOtp({ email: authEmail.value, options: { emailRedirectTo: window.location.href } });
      if (error) {
        authStatusPasscode.textContent = 'We couldn’t send the email. Try again or use your password.';
        authStatusPasscodeHint.style.display = 'none';
        return;
      }
      authStatusPasscode.textContent = 'We’ll email you a secure one-time sign-in link.';
      authStatusPasscodeHint.style.display = 'block';
    });
    headerSignIn.addEventListener('click', () => {
      authModalTitle.textContent = 'Sign in to save & track history';
      authModalDesc.textContent = 'Sign in to save results and track your history. Calculations work without an account.';
      openAuthModal('signin');
    });
    authSubmitUpdate.addEventListener('click', async (e) => {
      e.preventDefault();
      if (!supabase) {
        authStatusUpdate.textContent = 'Supabase unavailable. Please retry when online.';
        return;
      }
      if (!authPasswordNew.value) {
        authStatusUpdate.textContent = 'Enter a new password.';
        return;
      }
      authStatusUpdate.textContent = 'Updating password...';
      const { error } = await supabase.auth.updateUser({ password: authPasswordNew.value });
      if (error) {
        authStatusUpdate.textContent = 'Could not update password. Please try again.';
        return;
      }
      authStatusUpdate.textContent = 'Password updated. Please sign in with your new password.';
      await supabase.auth.signOut();
      window.location.href = '/';
    });

    signoutBtn.addEventListener('click', async () => {
      if (supabase) {
        await supabase.auth.signOut();
      }
      appState.companyId = null;
      await refreshSessionDisplay();
    });
    if (headerSignout) {
      headerSignout.addEventListener('click', async () => {
        if (supabase) {
          await supabase.auth.signOut();
        }
        appState.companyId = null;
        await refreshSessionDisplay();
        // Silent sign-out; no alert to avoid popups
      });
    }

    const handleSaveFlow = async () => {
      if (!appState.session) {
        authModalTitle.textContent = 'Sign in to save & track history';
        authModalDesc.textContent = 'Sign in to save results and track your history. Calculations work without an account.';
        openAuthModal('signin');
        appState.saving = true;
        return;
      }
      appState.saving = false;
      if (!appState.companyId) {
        appState.companyId = await getOrCreateCompany();
        if (!appState.companyId) return;
      }
      await upsertRecord(appState.companyId);
    };

    saveBtn.addEventListener('click', () => {
      if (!appState.lastCalculation) {
        alert('Calculate before saving.');
        return;
      }
      handleSaveFlow();
    });

    historyLink.addEventListener('click', (e) => {
      e.preventDefault();
      showHistorySection();
    });
    if (recordsSignout) {
      recordsSignout.addEventListener('click', async () => {
        if (supabase) await supabase.auth.signOut();
        window.location.href = '/';
      });
    }

    const findRecordById = (id) => openRecord(id) || appState.records.find((r) => r.id === id);

    const openModal = (el) => el && el.classList.add('active');
    const closeModal = (el) => el && el.classList.remove('active');

    viewClose.addEventListener('click', () => closeModal(viewModal));
    editClose.addEventListener('click', () => closeModal(editModal));

    const renderViewModal = (record) => {
      if (!record) return;
      viewBody.innerHTML = `
        <div class="two-col">
          <div><strong>Billing period</strong><br>${record.period_year}-${String(record.period_month).padStart(2, '0')}</div>
          <div><strong>Company</strong><br>${record.companies?.company_name || '—'}</div>
        </div>
        <div class="two-col">
          <div><strong>Country / region</strong><br>${record.calc_country || '—'}${record.calc_region ? ' / ' + record.calc_region : ''}</div>
          <div><strong>kWh</strong><br>${formatNumber(record.kwh, 0)}</div>
        </div>
        <div class="two-col">
          <div><strong>Location-based</strong><br>${formatNumber(record.location_based_emissions, 3)} t CO₂e</div>
          <div><strong>Market-based</strong><br>${record.market_based_emissions != null ? formatNumber(record.market_based_emissions, 3) + ' t CO₂e' : '—'}</div>
        </div>
        <div class="two-col">
          <div><strong>Emission factor</strong><br>${formatNumber(record.emission_factor_value, 6)} t CO₂e/kWh</div>
          <div><strong>Factor source</strong><br>${record.emission_factor_source} ${record.emission_factor_year}</div>
        </div>
      `;
      openModal(viewModal);
    };

    const openEditModal = (record) => {
      if (!record) return;
      appState.editingRecordId = record.id;
      editPeriod.value = `${record.period_year}-${String(record.period_month).padStart(2, '0')}`;
      editFactor.value = `${record.emission_factor_source} ${record.emission_factor_year}`;
      editKwh.value = record.kwh;
      editMarketType.value = record.market_instrument_type || '';
      editCovered.value = record.covered_kwh != null ? record.covered_kwh : '';
      editStatus.textContent = '';
      openModal(editModal);
    };

    if (recordsTbody) {
      recordsTbody.addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-action]');
        if (!btn) return;
        const id = btn.getAttribute('data-id');
        const action = btn.getAttribute('data-action');
        const record = findRecordById(id);
        if (!record) return;
        if (action === 'view') {
          if (window.openRecordPanel) {
            window.openRecordPanel(id, 'recordPanel');
          } else {
            renderViewModal(record);
          }
        }
        if (action === 'edit') {
          openEditModal(record);
        }
        if (action === 'delete') {
          const confirmDelete = confirm('Are you sure you want to delete this record?');
          if (!confirmDelete) return;
          supabase.from('scope2_records').delete().eq('id', id).then(({ error }) => {
            if (error) {
              alert('Delete failed. Please try again.');
              return;
            }
            refreshRecordsFromRemote();
          });
        }
      });
    }

    editForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!supabase) {
        editStatus.textContent = 'Supabase unavailable. Please retry when online.';
        return;
      }
      const record = findRecordById(appState.editingRecordId);
      if (!record) {
        editStatus.textContent = 'Record not found.';
        return;
      }
      const kwhVal = parseFloat(editKwh.value || '0');
      const coveredVal = parseFloat(editCovered.value || '0');
      if (!kwhVal || kwhVal <= 0) {
        editStatus.textContent = 'Enter a valid kWh.';
        return;
      }
      const covered = !Number.isNaN(coveredVal) && coveredVal >= 0 ? coveredVal : 0;
      const factorVal = record.emission_factor_value;
      const tonsLocation = kwhVal * factorVal;
      const tonsMarket = covered > 0 ? Math.max(kwhVal - covered, 0) * factorVal : tonsLocation;
      editStatus.textContent = 'Saving...';
      const { error } = await supabase.from('scope2_records').update({
        kwh: kwhVal,
        location_based_emissions: tonsLocation,
        market_based_emissions: record.market_based_emissions != null ? tonsMarket : null,
        market_instrument_type: editMarketType.value || null,
        covered_kwh: covered
      }).eq('id', record.id);
      if (error) {
        editStatus.textContent = 'Save failed. Please try again.';
        return;
      }
      editStatus.textContent = 'Saved.';
      closeModal(editModal);
      refreshRecordsFromRemote();
    });

    const getOrCreateCompany = async () => {
      // Try existing company
      if (!supabase) {
        alert('Saving unavailable while offline.');
        return null;
      }
      const { data, error } = await supabase.from('companies').select('id').limit(1);
      if (error) {
        alert('Unable to fetch company.');
        return null;
      }
      if (data && data.length) return data[0].id;
      // Otherwise show company form
      authModalTitle.textContent = 'Add your company';
      authModalDesc.textContent = 'Provide company details to save results. No bill uploads required.';
      setAuthView('company');
      authModal.classList.add('active');
      return new Promise((resolve) => {
        const onSubmit = async (ev) => {
          ev.preventDefault();
          if (!companyName.value || !companyCountry.value) {
            alert('Company name and country are required.');
            return;
          }
          const { data: inserted, error: insertErr } = await supabase.from('companies').insert({
            user_id: appState.session?.user?.id,
            company_name: companyName.value.trim(),
            country: companyCountry.value,
            region: companyRegion.value.trim() || null
          }).select('id').single();
          if (insertErr) {
            console.error('Company save error', insertErr);
            alert('Could not save company.');
            return;
          }
          companyForm.removeEventListener('submit', onSubmit);
          companyBack.removeEventListener('click', onCancel);
          companyForm.style.display = 'none';
          authModal.classList.remove('active');
          resolve(inserted.id);
        };
        const onCancel = () => {
          companyForm.removeEventListener('submit', onSubmit);
          companyBack.removeEventListener('click', onCancel);
          companyForm.style.display = 'none';
          authModal.classList.remove('active');
          resolve(null);
        };
        companyForm.addEventListener('submit', onSubmit);
        companyBack.addEventListener('click', onCancel, { once: true });
      });
    };

    const upsertRecord = async (companyId) => {
      if (!appState.lastCalculation) {
        alert('Calculate before saving.');
        return;
      }
      const calc = appState.lastCalculation;
      if (!supabase) {
        alert('Saving unavailable while offline.');
        return;
      }
      const { data: existing } = await supabase
        .from('scope2_records')
        .select('id')
        .eq('company_id', companyId)
        .eq('period_year', calc.year)
        .eq('period_month', calc.month)
        .limit(1);
      if (existing && existing.length) {
        const confirmReplace = confirm('A record for this period already exists. Replace it?');
        if (!confirmReplace) return;
      }
      const payload = {
        user_id: appState.session.user.id,
        company_id: companyId,
        period_year: calc.year,
        period_month: calc.month,
        kwh: calc.kwh,
        location_based_emissions: calc.tonsLocation,
        market_based_emissions: calc.marketEnabled ? calc.tonsMarket : null,
        market_instrument_type: calc.marketEnabled ? calc.marketType : null,
        covered_kwh: calc.marketEnabled ? calc.coveredKwh : null,
        emission_factor_value: calc.factorValue,
        emission_factor_year: calc.factorYear,
        emission_factor_source: calc.factorSource,
        calc_country: calc.country,
        calc_region: calc.region
      };
      const { error } = await supabase
        .from('scope2_records')
        .upsert([payload], { onConflict: 'user_id,company_id,period_year,period_month' });
      if (error) {
        alert('Save failed. Please try again.');
        return;
      }
      alert('Saved.');
      refreshRecordsFromRemote();
    };

    const getEmissionFactor = (country, region) => {
      const countryData = EMISSION_FACTORS[country];
      const regionKey = normalizeKey(region);
      if (countryData?.regions && countryData.regions[regionKey]) {
        const data = selectFinalFactor(countryData.regions[regionKey], parseInt(yearEl.value, 10));
        if (data) return { ...data, regionLabel: `${country} – ${region}` };
      }
      if (countryData?.default) {
        const data = selectFinalFactor(countryData.default, parseInt(yearEl.value, 10));
        if (data) return { ...data, regionLabel: country };
      }
      const fallback = selectFinalFactor(GLOBAL_FALLBACK, parseInt(yearEl.value, 10)) || GLOBAL_FALLBACK[0];
      return { ...fallback, regionLabel: "Global average" };
    };

    countryEl.addEventListener('change', (e) => {
      setRegionOptions(e.target.value);
    });
    signupCompanyCountry.addEventListener('change', (e) => {
      setSignupRegionOptions(e.target.value);
    });

    yearEl.addEventListener('change', syncMonthOptions);
    marketToggleEl.addEventListener('change', (e) => {
      marketFields.style.display = e.target.checked ? 'grid' : 'none';
    });

    // Initialize dropdowns
    populateYears(yearEl);
    populateYears(marketYearEl);
    syncMonthOptions();
    setRegionOptions('');
    setSignupRegionOptions('');

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const persona = form.persona.value;
      const country = form.country.value || 'OTHER';
      const month = form.month.value;
      const year = parseInt(form.year.value, 10);
      const kwh = parseFloat(form.kwh.value || '0');
      const region = form.region.value.trim();
      const marketEnabled = marketToggleEl.checked;
      const marketType = marketTypeEl.value;
      const marketKwh = parseFloat(marketKwhEl.value || '0');
      const marketYear = parseInt(marketYearEl.value || `${CURRENT_YEAR}`, 10);

      if (!persona || !country || !month || !year || !kwh || kwh <= 0 || !region) {
        alert('Please complete all fields to calculate.');
        return;
      }

      // Validation to block future periods and distinguish current partial periods
      if (year > CURRENT_YEAR) {
        alert('Carbon emissions can only be calculated for past or current periods.');
        return;
      }
      const monthNumber = MONTHS.indexOf(month) + 1; // Jan=1..Dec=12
      if (year === CURRENT_YEAR && monthNumber > CURRENT_MONTH) {
        alert('Future months are not supported. Please select a completed or current billing period.');
        return;
      }

      if (marketEnabled) {
        if (!marketType || Number.isNaN(marketKwh) || marketKwh < 0 || !marketYear) {
          alert('Please provide market-based instrument type, covered kWh, and reporting year.');
          return;
        }
        if (marketYear > CURRENT_YEAR) {
          alert('Carbon emissions can only be calculated for past or current periods.');
          return;
        }
        if (marketKwh > kwh) {
          alert('Covered electricity (kWh) cannot exceed total electricity used.');
          return;
        }
      }

      const factorData = getEmissionFactor(country, region);
      const factor = factorData.factor;
      const tonsLocation = kwh * factor;
      const coveredKwh = marketEnabled ? Math.min(marketKwh, kwh) : 0;
      const uncoveredKwh = Math.max(kwh - coveredKwh, 0);
      const tonsMarket = marketEnabled ? uncoveredKwh * factor : tonsLocation;
      // Keep location-based and market-based as separate values for downstream export/reporting
      const miles = tonsLocation * CAR_MILES_PER_TON;
      const homes = kwh / AVG_HOME_KWH_MONTH;

      tonsEl.textContent = `${formatNumber(tonsLocation, 3)} t CO₂e`;
      compareEl.textContent = `${formatNumber(tonsLocation * CAR_MILES_PER_TON, 0)} car miles or ${formatNumber(homes, 1)} homes for a month`;
      nextEl.textContent = persona === 'finance'
        ? 'Save this number for your monthly close and share with leadership.'
        : persona === 'advisor'
          ? 'Use this as a directional input in your client’s ESG summary.'
          : 'Track this month-over-month to spot reductions and set targets.';
      resultMarketEl.textContent = marketEnabled
        ? `${formatNumber(tonsMarket, 3)} t CO₂e`
        : 'Not provided';

      const factorSentence = `This estimate uses ${factorData.year} ${factorData.source} location-based electricity emission factors for ${factorData.regionLabel} (${formatNumber(factor, 6)} t CO₂e/kWh, version ${factorData.version}).`;
      calcDetailsEl.textContent = factorSentence;

      const isPartialCurrent = year === CURRENT_YEAR && monthNumber === CURRENT_MONTH;
      const partialNote = isPartialCurrent ? ' Partial period estimate: This calculation is based on usage entered for the current month and may change once the billing period is complete.' : '';
      interpretationEl.textContent = `For ${month} ${year} in ${region}, your electricity use generates about ${formatNumber(tonsLocation, 3)} metric tons CO₂e (location-based).${partialNote}`;

      // Show data currency disclaimer when billing year exceeds factor year
      if (year > factorData.year || (marketEnabled && marketYear > factorData.year)) {
        factorMismatchEl.style.display = 'block';
        factorMismatchEl.textContent = 'Emission factors are published with a delay. This calculation uses the most recent available data.';
      } else {
        factorMismatchEl.style.display = 'none';
        factorMismatchEl.textContent = '';
      }

      if (marketEnabled) {
        marketDisclaimer.style.display = 'block';
        marketDetails.textContent = `Instrument: ${marketType} • Covered kWh: ${formatNumber(coveredKwh, 0)} • Reporting year: ${marketYear}. Market-based emissions depend on contractual instruments and are reported separately from location-based emissions.`;
      } else {
        marketDisclaimer.style.display = 'none';
        marketDetails.textContent = '';
      }

    appState.lastCalculation = {
      year,
      month: monthNumber,
      monthName: month,
      kwh,
        country,
        region,
        factorValue: factor,
        factorYear: factorData.year,
        factorSource: factorData.source,
        factorVersion: factorData.version,
        tonsLocation,
        tonsMarket,
        marketEnabled,
        marketType: marketEnabled ? marketType : null,
      coveredKwh: marketEnabled ? coveredKwh : null
    };

    placeholder.style.display = 'none';
    resultContainer.classList.add('active');
    resultContainer.scrollIntoView({ behavior: 'smooth' });
    });

    // Kick off auth session detection on load (safe if supabase fails to load)
    initSupabaseClient().then(() => initAuth());
  </script>
</body>
</html>
